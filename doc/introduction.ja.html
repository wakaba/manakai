<?xml version="1.0" encoding="iso-2022-jp"?>
<?xml-stylesheet href="/s/simpledoc.css" type="text/css" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
   "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xml:lang="ja" xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>manakai (旧称 Message::* Perl modules)</title>
<link rel="index" href="./" />
<link rel="stylesheet" href="/s/simpledoc.css" type="text/css" />
<link rev="made" href="mailto:w@suika.fam.cx" />
<link rel="copyright" href="/c/pd" title="Public Domain." />
<meta name="author" content="若葉" />
<meta name="keywords" content="Perl, module, pm, Message, RFC 822, RFC 2822, RFC 1036, son-of-RFC1036, MIME, Usefor, HTTP, CGI, header, field" />
</head>
<body style="color:gray">
<h1>manakai (旧称 Message::* Perl modules)</h1>

<section style="display:block;margin:3em auto;border:red 1em solid;padding:1em;color:red;background:white;font-size:200%;text-align:center;max-width:15em">
This page is no longer maintained.
See <a href="http://manakai.github.io/">new project page</a>.
</section>

<p>注意: この文書の内容には古い事柄が含まれています。
最新の情報は
<a href="/~wakaba/-temp/wiki/wiki?manakai">SuikaWiki:manakai</a>
をご覧ください。</p>

<h2>はじめのはじめに</h2>

<p>たとえば Perl で書かれた CGI script, それも掲示板なんかには、
こんなみっともない code が載っていたりします。</p>

<pre class="example"><code class="perl">jcode'convert(*from, "jis");
jcode'convert(*subject, "jis");
jcode'convert(*message, "jis");
open (MAIL, "| $sendmail");
print MAIL "From: $mail ($from)\n";
print MAIL "To: $mailto\n";
print MAIL "Subject: $subject\n";
print MAIL "\n";
print MAIL "$message";
print MAIL "\n";
close (MAIL);
</code></pre>

<p>これでは視認性も良くないですし、うっかり修正し間違えると
変なメッセージを送信してしまいます。
(筆者はしょっちゅうはまってました:-)
(それに多くの code では、
HTML でのクロスサイトスクリプティング (CSS) 問題と
類似の問題への対処をしていません。)</p>

<p>オブジェクト指向を取り入れて次のような感じでメッセージを
構成したいところです。</p>

<pre class="application-x-perl">
use Message::Entity;
my $msg = new Message::Entity;
my $hdr = $msg-&gt;header;
$hdr-&gt;add ('From')-&gt;add ('me@bar.example');
$hdr-&gt;add ('To')-&gt;add (['foo@bar.example', display_name =&gt; 'Mr. foo']);
$hdr-&gt;add (Subject =&gt; $subject);
$msg-&gt;body ($body);

# $smtp-&gt;send は SMTP で送信する method と仮定。
$smtp-&gt;send ($msg);
</pre>

<p><a href="http://www.cpan.org/" xml:lang="en">CPAN</a> を探すと、
これに似たようなことができそうなモジュールはあるようですが、
実際に使ってみると、与える値によっては <a href="urn:ietf:rfc:822">RFC 822</a>/<a href="urn:ietf:rfc:2822">2822</a> に違反する
結果を出力するとか、そもそもそれ以前に、
<code>$hdr->addr ('Foo Bar &lt;foo@bar.example>')</code> 
のようにメッセージ形式をモジュール内に隠匿しきれていないとか、非
ASCII 文字を考慮していないとかの不満があります。</p>

<p class="note">(実装方針としては不正な値はモジュールに渡す前に弾くべきという考え方もあるでしょうけど、一般的な利用に際しては賢い設計だとは思えません。)</p>

<p>ということで、はじめは既存のモジュールの wrapper (あるいは補完) 
を書くつもりでしたが、なんだかごちゃごちゃしていて、
それなら車輪の再発明になっても一から書いてみようと考えました。</p>

<h2>特色 (という程のものでもない。)</h2>

<ol>
<li>結構オブジェクト指向です。</li>
<li>RFC 822/2822 の <code class="bnf rfc2822">group</code> を解釈出来ます。</li>
<li><a href="urn:ietf:id:draft-ietf-usefor-msg-id-alt-00">draft-ietf-usefor-msg-id-alt-00</a> に基づいた送信アドレスなどによる <code class="rfc2822">Message-ID</code> を生成出来ます。</li>
<li><a href="charset" title="文字コードの扱い">文字コード変換処理を外部に追い出しています</a>。
jcode.pl でも Jcode.pm でも Encode::* でも、好きなものをお使い下さい。</li>
<li>MIME (<a href="urn:ietf:rfc:2045">RFC 2045</a>, 
<a href="urn:ietf:rfc:2046">2046</a>) にほぼ完全に対応しています。</li>
</ol>

<h2>各仕様への対応状況</h2>

<ol>
<li>電子メイルのメッセージ (RFC 822, RFC 2822) 
の全機能に対応しています。</li>
<li>電子ニュース記事 (<a href="/uri-res/N2L?urn:ietf:rfc:1036">RFC 1036</a>,
<a href="spec/son-of-RFC1036">son-of-RFC1036</a>,
<a href="/uri-res/N2L?urn:ietf:id:draft-usefor-article-06">
draft-usefor-article (06)</a>) の頭領域の多くに対応しています。</li>
<li>MIME の本文部分 (body part) に対応しています。
	<ul>
	<li>多部分 (multipart) や分割 (message/partial),
	外部本分 (message/external-body) を扱うことが出来ます。</li>
	<li>text/plain; format=flowed 
	(<a href="urn:ietf:rfc:2646">RFC 2646</a>)
	に対応しています。</li>
	<li>Content-Transfer-Encoding は Base64, Quoted-Printable
	は勿論、 x-uuencode, x-gzip64 にも対応。
	RFC 2822 メイル出力モードでは、本文が8ビットでも自動的に適切な
	CTE で符号化します。</li>
	</ul>
</li>
<li>MIME の頭領域 
(<a href="/uri-res/N2L?urn:ietf:rfc:2045">RFC 2045</a>,
<code class="mime">Content-Disposition</code>) に対応しています。
パラメーター値拡張 (<a href="/uri-res/N2L?urn:ietf:rfc:2231">RFC 2231</a>)
も入出力ともに実装しました。</li>
<li>MIME 符号化語 (<code class="mime bnf">encoded-word</code>)
の解読に対応しています:-)</li>
<li>HTTP/1.0, HTTP/1.1, CGI/1.1, CGI/1.2 の頭領域のうち、
ごく一部に対応しています。 MHTML の 
<code class="mime">Content-Location</code> にも対応しています。</li>
<li>日付形式では RFC 822/<a href="urn:ietf:rfc:1123">1123</a>, 
<a href="urn:ietf:rfc:733">RFC 733</a>, asctime, ISO 8601 (HTML) 
などに対応しています。日付の出力は sprintf
の様な書式文字列を与えることで、多種多様な形式に対応。</li>
<li>X-Moe シリーズに対応しています:-)</li>
</ol>

<h2>制限事項</h2>

<ol>
<li>類似モジュール(謎)のように、ファイル名やファイル・ハンドルを
渡して読み込ませることが出来ません。</li>
<li>大きなメッセージでも一気に読み込み、全て主記憶領域で
保持しています。ですからあまり大きなメッセージの処理には
向いていないでしょう。</li>
<li><code>CR</code> や <code>LF</code> が単体で出現する場合、
正しく処理出来<del>ません</del><ins>ないことがあります 
(近い将来の版で改善の予定)</ins>。 (<code>CRLF</code> と等価とみなします。)
将来の版ではオプションで制御可能になるかもしれません。</li>
<li>説明文 (document; pod) がいい加減です (書くのが面倒だ)。</li>
</ol>

<h2>必要環境</h2>

<ol>
<li>Perl 5.6 以降
	<p class="note"><code class="bnf rfc822">comment</code>
	を表すのに正規表現 
	<code class="regex">(??{ <var>code</var> })</code> 
	を使っているので、これを解釈出来る、 
	5.6 以降の版である必要があります。</p>
</li>
<li>Digest::MD2, Digest::MD5, Digest::SHA1
	<p>Message-ID の生成にこれらを使用する場合のみ、
	Message::Field::MsgID が使います。</p>
	<p><code class="bnf mime">Content-MD5:</code> 領域の付加や検証を行う場合、 
	Digest::MD5 が必要です。 (Message::Entity)</p>
</li>
<li>MIME::Base64
	<p>ちなみに、 Quoted-Printable や RFC 2231 の
	% 符号化は自力で復号します。</p>
</li>
<li>文字コード変換処理
	<p>日本語メッセージを扱うなら必須でしょう。
	詳しくは<a href="#code">文字コードの扱い</a>
	の章をご参照下さい。</p>
</li>
</ol>

<h2>入手</h2>

<p>suika.fam.cx の SSH account をお持ちの場合、 CVS から入手出来ます。</p>

<p class="example"><samp>$ </samp><kbd>cvs -d :ext:<var xml:lang="en">username</var>@suika.fam.cx:/home/cvs co messaging/manakai</kbd></p>

<p>Web からも取り出せます: 
<code class="uri">&lt;<a href="/gate/cvs/messaging/manakai/">http://suika.fam.cx/gate/cvs/messaging/manakai/</a>&gt;</code></p>

<p><a href="/gate/cvs/messaging/manakai/manakai.tar.gz?tarball=1">最新開発版 
snapshot の tarball を取得</a>することもできます。</p>

<h2>ライセンス</h2>

<p>manakai は自由ソフトウェアです。
<a href="http://www.gnu.org/">GNU</a> 
<a href="/c/gnu/gpl">GPL</a> に従って利用出来ます。
詳しくは各構成ファイルを御覧下さい。</p>

<h2>関連文書など</h2>

<ul>
<li id="code"><a href="charset">文字コードの扱い</a></li>
<li><a href="/~wakaba/-temp/wiki/wiki?manakai">SuikaWiki:manakai</a></li>
</ul>

<h2>応用</h2>

<ul>
<li><a href="/gate/cvs/tool/bunshin/">Bunshin.pm</a>
	<p>Web 上の連続する資源 (掲示板の記事のようなもの)
	を切り出して RFC 822 形式のメッセージにするエンジン部分。</p>
</li>
<li><a href="/gate/cvs/tool/suikawari/">すいかわり</a>
	<p>Bunshin.pm を使って、電子ニュースに記事を投稿する
	script。 (cron とかから呼び出して使う。)</p>
</li>
</ul>

<h2>今後の予定</h2>

<ol>
<li>電子ニュースの頭領域 (RFC 1036, 
<a href="spec/son-of-RFC1036">son-of-RFC1036</a>, 
draft-usefor-article) の完全実装</li>
<li>追加/非標準の頭領域の実装。</li>
<li>documentation。</li>
<li>使用例の作成。</li>
<li>既存モジュールが利用出来る部分は、それを呼び出すようにするか
その code を流用する。</li>
<li>類似モジュールとの界面の共通化</li>
<li>HTTP 用に使えるようにする</li>
</ol>

<div class="navigation">
[<a href="/" title="このサーバーの首頁">/</a>
<a href="/map" title="このサーバーの案内" rel="index">地図</a>
<a href="/search/" title="このサーバーの検索">検索</a>]
<a href="http://validator.w3.org/check/referer" xml:lang="en"><img
        src="http://www.w3.org/Icons/valid-xhtml11" id="w3c-html"
        alt="Valid XHTML 1.1!" style="height: 31px; width: 88px" /></a>
<a href="http://jigsaw.w3.org/css-validator/validator?uri=http://suika.fam.cx/~wakaba/Message-pm/introduction.ja.html" xml:lang="en">
  <img style="width: 88px; height: 31px" id="w3c-css"
       src="http://jigsaw.w3.org/css-validator/images/vcss" 
       alt="Valid CSS!" /></a>
</div>
<div class="update">$Date: 2003/08/17 03:37:53 $</div>
<ul class="myuri">
<li>&lt;URL:<a href="http://suika.fam.cx/~wakaba/Message-pm/introduction">http://suika.fam.cx/~wakaba/Message-pm/introduction</a>&gt;</li>
<li>&lt;CVS:<a href="http://suika.fam.cx/gate/cvs/perl/web/Message-pm/">suika.fam.cx:/home/cvs/perl/web/Message-pm/</a>&gt;</li>
</ul>
</body></html>
