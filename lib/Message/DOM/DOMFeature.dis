Module:
  @QName:
    MDOM:DOMFeature
  @FullName:
    @@lang: en
    @@@: DOM Feature
  @Namespace:
    http://suika.fam.cx/~wakaba/archive/2004/dom/feature#
  @idl:prefix: manakai.suika.fam.cx
  @idl:moduleName: mi
  @j:packageQualifiedName: cx.fam.suika.manakai
  
  @Description:
    @@lang:en
    @@@:
      The manakai <Module::MDOM:DOMFeature> module provides interfaces 
      and classes to obtain DOM implementations.  They might also
      be useful for any other frameworks which is friendly for
      DOM application developers.

      The <Class::ImplementationRegistry> object
      is the bootstrap for the DOM implementations; DOM
      applications can ask to return DOM implementations
      which support the desired feature.  This mechanism is
      basically defined in the <CITE::DOM Level 3 Core> specification
      and this module defines a Perl binding for it.

      The <IF::MinimumImplementation> interface defines
      the minimum interface that should be implemented by
      all DOM implementations and other implementations
      that is intended to be accessible via 
      the manakai <Class::ImplementationRegistry>
      object.  The interface contains methods to obtain
      an object which implements particular feature so
      that rich implementations which implement more than
      one interfaces offer their feature to applications 
      in the common manner.  This interface is manakai
      specific but it is a subset of the DOM Level 3
      <IF::DOMCore:DOMImplementation::ManakaiDOM:ManakaiDOM3>
      interface.

  @DISCore:author: DISCore|Wakaba
  @License:
     license:Perl+MPL
  @Date:
    @@@:
      $Date: 2006/02/25 16:49:56 $
    @@ContentType:
      dis:Date.RCS
  
  @Require:
    @@Module:
      @@@QName: DISlib|DISIDL
      @@@WithFor: ManakaiDOM|all
      @@@ImplNote:
        @@@@lang:en
        @@@@@:
          <Module::DISlib|DISPerl>, <Module::DISlib|Java>,
          <Module::DISlib|ECMAScript> is also referenced.
    @@Module:
      @@@QName:
        UtilError:DOMException
      @@@WithFor:
        ManakaiDOM:all
    @@Module:
      @@@QName:
        Util:ManakaiNode
      @@@WithFor:
        ManakaiDOM:Perl
    @@Module:
      @@@WithFor:
        ManakaiDOM:ManakaiDOM
    @@Module:
      @@@WithFor:
        ManakaiDOM:ManakaiDOM3
    @@Module:
      @@@WithFor:
        ManakaiDOM:ManakaiDOMLatest
    @@Module:
      @@@QName: DISlib|Test
      @@@WithFor: ManakaiDOM|all
  @DefaultFor:
    ManakaiDOM:ManakaiDOMLatest

Namespace:
  @def:
    http://suika.fam.cx/~wakaba/archive/2004/dom/feature#spec.
  @dis:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/lang#dis--
  @DISlib:
    http://suika.fam.cx/~wakaba/archive/2004/dis/
  @doc:
    http://suika.fam.cx/~wakaba/archive/2004/dis/Document#
  @DOMCore:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/dom-core#
  @DOMEvents:
    http://suika.fam.cx/~wakaba/archive/2004/dom/events#
  @DOMMain:
    http://suika.fam.cx/~wakaba/archive/2004/dom/main#
  @DOMMetaImpl:
    http://suika.fam.cx/~wakaba/archive/2004/dom/meta#
  @dx:
    http://suika.fam.cx/~wakaba/archive/2005/manakai/Util/Error/DOMException#
  @f:
    http://suika.fam.cx/~wakaba/archive/2004/dom/feature#
  @fe:
    http://suika.fam.cx/www/2006/feature/
  @idl:
    http://suika.fam.cx/~wakaba/archive/2004/dis/IDL#
  @infoset:
    http://www.w3.org/2001/04/infoset#
  @j:
    http://suika.fam.cx/~wakaba/archive/2004/dis/Java#
  @jlang:
    java:java.lang.
  @js:
    http://suika.fam.cx/~wakaba/archive/2004/dis/ECMAScript#
  @kwd:
    http://suika.fam.cx/~wakaba/archive/2005/rfc2119/
  @lang:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/lang#
  @license:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/license#
  @ManakaiDOM:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/manakai-dom#
  @MDOM:
    http://suika.fam.cx/~wakaba/archive/2004/8/18/manakai-dom#ManakaiDOM.
  @MDOMX:
    http://suika.fam.cx/~wakaba/archive/2004/8/4/manakai-dom-exception#
  @mn:
    http://suika.fam.cx/~wakaba/archive/2005/manakai/Util/ManakaiNode#
  @p:
    http://suika.fam.cx/~wakaba/archive/2004/dis/Perl#
  @rdf:
    http://www.w3.org/1999/02/22-rdf-syntax-ns#
  @rdfs:
    http://www.w3.org/2000/01/rdf-schema#
  @test:
    http://suika.fam.cx/~wakaba/archive/2004/dis/Test#
  @ty:
    http://suika.fam.cx/~wakaba/archive/2005/7/tutorial#
  @Util:
    http://suika.fam.cx/~wakaba/archive/2005/manakai/Util/
  @UtilError:
    http://suika.fam.cx/~wakaba/archive/2005/manakai/Util/Error/
  @xml:
    http://www.w3.org/XML/1998/namespace
  @xmlns:
    http://www.w3.org/2000/xmlns/

ResourceDef:
  @QName:
    MDOM:
  @rdf:type:
    dis:ModuleGroup
  @FullName:
    @@lang:en
    @@@:
      The manakai DOM modules
  @DISPerl:packageName:
    @@@:
      Message::DOM::
    @@For: ManakaiDOM|ManakaiDOM
    @@ManakaiDOM:moduleSuffix:
      @@@@: Level3
      @@@For: ManakaiDOM|ManakaiDOM3 !ManakaiDOM|ManakaiDOMLatest
    @@ManakaiDOM:moduleSuffix:
      @@@@: Level2
      @@@For: ManakaiDOM|ManakaiDOM2 !ManakaiDOM|ManakaiDOM3
    @@ManakaiDOM:moduleSuffix:
      @@@@: Level1
      @@@For: ManakaiDOM|ManakaiDOM1 !ManakaiDOM|ManakaiDOM2
  @DISPerl:interfacePackageName:
    @@@:
      Message::DOM::IFLatest::
    @@For: ManakaiDOM|ManakaiDOMLatest
  @DISPerl:interfacePackageName:
    @@@:
      Message::DOM::IFLevel3::
    @@For: ManakaiDOM|ManakaiDOM3 !ManakaiDOM|ManakaiDOMLatest
    @@For: ManakaiDOM|ForSpec3
  @DISPerl:interfacePackageName:
    @@@:
      Message::DOM::IFLevel2::
    @@For: ManakaiDOM|ManakaiDOM2 !ManakaiDOM|ManakaiDOM3
  @DISPerl:interfacePackageName:
    @@@:
      Message::DOM::IFLevel1::
    @@For: ManakaiDOM|ManakaiDOM1 !ManakaiDOM|ManakaiDOM2
  @DISPerl:interfacePackageName:
    @@@:
      Message::DOM::IF::
    @@For: ManakaiDOM|ManakaiDOM !ManakaiDOM|ManakaiDOM1
  @ImplNote:
    @@lang:en
    @@@:
      This resource is also defined in <Module::MDOM|DOMMain>
      module for <Q::ManakaiDOM|ManakaiDOM1> and <Q::ManakaiDOM|ManakaiDOM2>.

## -- "For" definitions

## For the Document Object Model

ForDef:
  @QName:
    ManakaiDOM:DOM
  @FullName:
    @@lang:en
    @@@: For DOM
ForDef:
  @QName:
    ManakaiDOM:DOM1
  @FullName:
    @@lang:en
    @@@: For DOM Level 1
  @ISA:
    ManakaiDOM:DOM
ForDef:
  @QName:
    ManakaiDOM:DOM2
  @FullName:
    @@lang:en
    @@@: For DOM Level 2
  @ISA:
    ManakaiDOM:DOM1
ForDef:
  @QName:
    ManakaiDOM:DOM3
  @FullName:
    @@lang:en
    @@@: For DOM Level 3
  @ISA:
    ManakaiDOM:DOM2
ForDef:
  @QName:
    ManakaiDOM:DOMLatest
  @FullName:
    @@lang:en
    @@@: For the latest level of DOM
  @ISA:
    ManakaiDOM:DOM3

ForDef:
  @QName: 
    ManakaiDOM:DOMHTMLFeature
  @FullName:
    @@lang:en
    @@@: For DOM HTML feature, any version
  @ISA:
    ManakaiDOM:DOM

ForDef:
  @QName: 
    ManakaiDOM:DOMXMLFeature
  @FullName:
    @@lang:en
    @@@: For DOM XML feature, any version
  @ISA:
    ManakaiDOM:DOM

ForDef:
  @QName: ManakaiDOM|DOMXMLFeatureXML11
  @FullName:
    @@lang:en
    @@@: For DOM XML feature, any version, with XML 1.1 support
  @ISA: ManakaiDOM|DOMXMLFeature

ForDef:
  @QName:
    ManakaiDOM:DOMEventsFeature
  @FullName:
    @@lang:en
    @@@:  For DOM Events feature, any version
  @ISA:
    ManakaiDOM:DOM

## For the manakai DOM implementation

ForDef:
  @QName:
    ManakaiDOM:ManakaiDOM
  @FullName:
    @@lang:en
    @@@: For the manakai DOM implementation
  @Implement:
    ManakaiDOM:DOM
  @ISA:
    ManakaiDOM:Perl
ForDef:
  @QName:
    ManakaiDOM:ManakaiDOM1
  @FullName:
    @@lang:en
    @@@: For the manakai DOM Level 1 implementation
  @Implement:
    ManakaiDOM:DOM1
  @Implement: 
    ManakaiDOM:DOMXMLFeature
  @Implement: 
    ManakaiDOM:DOMHTMLFeature
  @Implement:
    ManakaiDOM:DOMEventsFeature
  @ISA:
    ManakaiDOM:ManakaiDOM
ForDef:
  @QName:
    ManakaiDOM:ManakaiDOM2
  @FullName:
    @@lang:en
    @@@: For the manakai DOM Level 2 implementation
  @Implement:
    ManakaiDOM:DOM2
  @ISA:
    ManakaiDOM:ManakaiDOM1
ForDef:
  @QName:
    ManakaiDOM:ManakaiDOM3
  @FullName:
    @@lang:en
    @@@: For the manakai DOM Level 3 implementation
  @Implement:
    ManakaiDOM:DOM3
  @ISA:
    ManakaiDOM:ManakaiDOM2
  @ISA: ManakaiDOM|DOMXMLFeatureXML11
ForDef:
  @QName:
    ManakaiDOM:ManakaiDOMLatest
  @FullName:
    @@lang:en
    @@@: For the manakai implementation of the latest level of DOM
  @Implement:
    ManakaiDOM:DOMLatest
  @ISA:
    ManakaiDOM:ManakaiDOM3

ForDef:
  @QName: ManakaiDOM|ForSpec
  @ISA: doc|ForDoc
  @ISA: ManakaiDOM|DOM
  @FullName:
    @@lang:en
    @@@: For specification

ForDef:
  @QName: ManakaiDOM|ForSpec3
  @ISA: ManakaiDOM|DOM3
  @ISA: ManakaiDOM|ForSpec
  @FullName:
    @@lang:en
    @@@: For Level 3 of specification

ForDef:
  @QName: ManakaiDOM|ForSpecLatest
  @ISA: ManakaiDOM|DOMLatest
  @ISA: ManakaiDOM|ForSpec3
  @FullName:
    @@@: For the latest version of specification
    @@lang:en

ForDef:
  @QName: ManakaiDOM|ForSpecAll
  @ISA: ManakaiDOM|ForSpec
  @ISA: ManakaiDOM|Java

ForDef:
  @QName: ManakaiDOM|ForSpecIDL
  @ISA: ManakaiDOM|ForSpec
  @ISA: ManakaiDOM|Java

ForDef:
  @QName: ManakaiDOM|ForSpecJava
  @ISA: ManakaiDOM|ForSpec
  @ISA: ManakaiDOM|Java

ForDef:
  @QName: ManakaiDOM|ForSpecECMAScript
  @ISA: ManakaiDOM|ForSpec
  @ISA: ManakaiDOM|ECMAScript

ForDef:
  @QName: ManakaiDOM|ForSpecPerl
  @ISA: ManakaiDOM|ForSpec
  @ISA: ManakaiDOM|Perl

## -- The DOM "feature" system

StringDataTypeDef:
  @QName: FeatureNameString
  @FullName:
    @@lang:en
    @@@: DOM feature name

  @enTitle: Feature Names

  @enDesc:
    Features are identified by pairs of <DFN::feature name>s (which
    is often referred simply as <QUOTE::features>) and
    feature versions.

    {ps::
      {ty:caption::Syntax
      }

      The syntax of feature names, that is, what kind of character
      sequences can be feature names, is not well-defined.

      In DOM Level 1 First Edition <bibref::DOM1FE>, which has introduced
      features, the only legal feature names are <Feature::HTML>
      and <Feature::XML>.

      In DOM Level 1 Second Edition on September, 2000 <bibref::DOM1SE>
      and DOM Level 2 Core Recommendation on November, 2000 <bibref::DOM2Core>,
      feature names are defined as XML <CODE::Name>s <bibref::XML10FE>.

      In DOM Level 3 <bibref::DOM3Core>, there is no explicit restriction
      defined on feature names, although the <CHAR::PLUS SIGN> rule
      described below prevents the use of <CHAR::PLUS SIGN> as the 
      first character of a feature name and the <CODE::features>
      parameters imply that white space characters must not 
      be used in feature names and feature names must be
      distingulishable from feature version numbers.

      {P:: The DOM Level 3 Minimum Implementation enforces the restrictions that:

        - The first character of feature names <kwd:MUST-NOT> be
          a <CHAR::PLUS SIGN>.  Feature names <kwd:SHOULD-NOT>
          contain one or more <CHAR::PLUS SIGN> characters.
        
        - The first character of feature names <kwd:MUST-NOT> be
          one from <CHAR::DIGIT ZERO>, <CHAR::DIGIT ONE>, 
          <CHAR::DIGIT TWO>, <CHAR::DIGIT THREE>, <CHAR::DIGIT FOUR>,
          <CHAR::DIGIT FIVE>, <CHAR::DIGIT SIX>, <CHAR::DIGIT SEVEN>,
          <CHAR::DIGIT EIGHT>, or <CHAR::DIGIT NINE>.

        - Feature names <kwd:MUST-NOT> contain white space characters
          such as <CHAR::SPACE> and <CHAR::HORIZONTAL TAB>.

        - A feature name defined outside W3C DOM specifications
          <kwd:SHOULD> be a URI <bibref::URI>.
      }
    }

    {ps::
      {ty:caption::Case-sensitivility
      }

      Feature names are case-insensitive <bibref::DOM1FE> <bibref::DOM1SE>
      <bibref::DOM2Core> <bibref::DOM3Core>.
    }

    {ps::
      {ty:caption::Nameing convention
      }
      
      In DOM Level 1 Second Edition on September, 2000 <bibref::DOM1SE> and
      DOM Level 2 Core Recommendation on November, 2000 <bibref::DOM2Core>,
      it was encouraged that feature names referring to features
      defined outside the DOM specifications should be made unique
      by <EM::reversed Internet domain name>.

      This suggestion was removed by DOM Level 2 Errata <bibref::DOM2Errata>.
      So, while DOM Level 2 and DOM Level 3 <bibref::DOM3Core> ask
      feature names being unique, the way to ensure the uniqueness
      is remain undefined.

      The DOM Level 3 Minimum Implementation specification recommends
      that URIs <bibref::URI> <kwd:SHOULD> be used for feature names.

      {NOTE:: For example, SVG 1.1, which is built on DOM Level 2,
              defined feature names as reversed Internet domain
              names.  SVG 1.2, which is built on DOM Level 3,
              deprecates SVG 1.1 feature names and defines URI
              feature names instead.
      }
    }

    {ps::
      {ty:caption::<CHAR::PLUS SIGN> Prepended to Feature Name
      }

      Some contexts allows a <CHAR::PLUS SIGN> prepended to
      any feature name.  It means that the feature may not directly
      castable but would be accessible in some manner, e.g.
      by binding-specific cast mechanism
      or by <M::GetFeature.getFeature> method.
      Some contexts simple ignores the first <CHAR::PLUS SIGN>.
      <bibref::DOM3Core>  Since this rule is introduced in 
      DOM Level 3, pre-Level 3 implementations might not 
      ignore the character even if it would be ignored in Level 3
      implementations.
    }

  @InputProcessor:
    @@PerlDef:
      $INPUT = lc $INPUT;

ResourceDef:
  @QName: 
    ManakaiDOM:ManakaiDOMFeatureName
  @AliasFor: FeatureNameString
  @For: ManakaiDOM|DOM1

ElementTypeBinding:
  @Name: InputProcessor
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type:
      DISLang:InputProcessor

StringDataTypeDef:
  @QName: FeatureVersionString
  @FullName:
    @@lang:en
    @@@: DOM feature version

  @enTitle: Feature Version Numbers

  @enDesc:
    <DFN::Feature version> identifies a version of the feature.

    {ps::
      {ty:caption::Syntax
      }

      Syntax of the feature version numbers are not well-defined.

      In DOM Level 1 <bibref::DOM1FE> <bibref::DOM1SE>, the
      only legal version number string was <FeatureVer::1.0>.
      
      In DOM Level 2 <bibref::DOM2Core>, the only legal version
      number strings were <FeatureVer::1.0> and <FeatureVer::2.0>.

      In DOM Level 3 <bibref::DOM3Core>, there is no explicit
      syntactical restriction on feature version numbers.

      The DOM Level 3 Minimum Implementation defines the 
      feature version numbers as one or more digits followed
      by a <CHAR::FULL STOP> followed by one or more digits,
      where a digit is a character from <CHAR::DIGIT ZERO>, <CHAR::DIGIT ONE>,
      <CHAR::DIGIT TWO>, <CHAR::DIGIT THREE>, <CHAR::DIGIT FOUR>,
      <CHAR::DIGIT FIVE>, <CHAR::DIGIT SIX>, <CHAR::DIGIT SEVEN>,
      <CHAR::DIGIT EIGHT>, or <CHAR::DIGIT NINE>.  The first
      character of the string or the first character just after
      the <CHAR::FULL STOP> <kwd:SHOULD-NOT> be a <CHAR::DIGIT ZERO>
      unless the character following it is a <CHAR::FULL STOP>
      or the character is the last character in the string.

      Some contexts where a feature version is expected also
      allow an empty string or <DOM::null>.  These values
      reference any version of the feature.  For example,
      method <M::GetFeature.hasFeature> with feature <Feature::Core>
      and version of <DOM::null> would return <DOM::true>
      if it has support for one or more of versions <FeatureVer::2.0>,
      <FeatureVer::3.0>, or any other version.  <bibref::DOM1FE>
      <bibref::DOM1SE> <bibref::DOM2Core> <bibref::DOM3Core>
    }

  @InputProcessor:
    @@PerlDef:
      $INPUT = '' unless defined $INPUT;

ResourceDef:
  @QName: 
    ManakaiDOM:ManakaiDOMFeatureVersion
  @AliasFor: FeatureVersionString
  @For: ManakaiDOM|DOM1

StringDataTypeDef:
  @QName: FeaturesString
  @For:
    ManakaiDOM:DOM3
  @For: ManakaiDOM|ForSpec3
  @FullName:
    @@lang:en
    @@@: 
      DOM <CODE::features>

  @enTitle:
    <CODE::features>

  @enDesc:
    Some methods takes a parameter known as <DFN::<CODE::features>>,
    which expects a list of zero or more features.

    {ps::
       {ty:caption::Syntax
       }

       A <CODE::features> string is a space-separeted list
       in which each feature is specified by its name optionally
       followed by a space and a version number.  A <CHAR::PLUS SIGN>
       may be prepended to a feature name.  <bibref::DOM3Core>

       What is a <QUOTE::space> is unclear.  In DOM Level 3
       Minimum Implementation, it <kwd:MUST> be a <CHAR::SPACE>.
       Implementations <kwd:MAY> accept any other <QUOTE::white space>
       characters either.  Implementations <kwd:MAY> choose also to
       simple ignore more than one white space characters or leading or trailing
       white space characters.

       In DOM Level 3 Minimum Implementation, the order in which
       features are specified is not significant.  A feature name
       <kwd:MAY> be specified more than once, with or without
       <CHAR::PLUS SIGN> and with or without any version numbers.
    }

    {ps::
      {ty:caption::<CODE::features> as Hash Reference
      }

      In Perl binding, applications can specify a reference to
      a hash where the <CODE::featuers>-list string is expected.
      Keys are considered as feature names and values are
      as their versions.  Values might be empty strings or <DOM::null>s.
      Implementations which receives such <CODE::features> values
      <kwd:MUST-NOT> modify hashs.

        {NOTE:: In this way, applications cannot specify
                a feature with more than one different versions
                at once.
        }

        {NOTE:: Perl application developers are advised not to
                forget to quote version number in source code
                when its fraction part is <CODE::0>.  For example,
                version <FeatureVer::2.0> must be quoted as
                <Perl::'2.0'> in Perl source code.
        }
    }

  @InputProcessor:
    @@PerlDef:
      __CODE{featuresParamToFeaturesHash::
        $INPUT => $INPUT,
        $RESULT => $INPUT,
      }__;

  @ResourceDef:
    @@QName: featuresParamToFeaturesHash
    @@rdf:type: DISPerl|BlockCode
    @@enDesc:
      Converts a value given as a <CODE::features> parameter (<Perl::$INPUT>)
      into a features hash (<Perl::$RESULT>).
    @@PerlDef:
      if (CORE::defined $INPUT) {
        if (CORE::ref ($INPUT) eq 'HASH') {
          my $__new = {};
          for my $__fname (keys %{$INPUT}) {
            if (CORE::ref ($INPUT->{$__fname}) eq 'HASH') {
              my $__lfname = lc $__fname;
              for my $__fver (keys %{$INPUT->{$__fname}}) {
                $__new->{$__lfname}->{$__fver} = $INPUT->{$__fname}->{$__fver};
              }
            } elsif (CORE::ref ($INPUT->{$__fname}) eq 'ARRAY') {
              my $__lfname = lc $__fname;
              for my $__fver (@{$INPUT->{$__fname}}) {
                $__new->{$__lfname}->{$__fver} = true;
              }
            } else {
              $__new->{lc $__fname} = {(CORE::defined $INPUT->{$__fname}
                                      ? $INPUT->{$__fname} : '') => true};
            }
          }
          $RESULT = $__new;
        } else {
          my @__f = split /\s+/, $INPUT;
          my $__new = {};
          while (@__f) {
            my $__name = lc shift @__f;
            if (@__f and $__f[0] =~ /^[\d\.]+$/) {
              $__new->{$__name}->{shift @__f} = 1;
            } else {
              $__new->{$__name}->{''} = 1;
            }
          }
          $RESULT = $__new;
        }
      } else {
        $RESULT = {};
      }

    @@Test:
      @@@QName: featuresParamToFeaturesHash.featureVersionsAsArray.test
      @@@PerlDef:
        my $in = {feature1 => [qw/1.0 2.0/]};
        my $out;

        __CODE{featuresParamToFeaturesHash:: $INPUT => $in, $RESULT => $out}__;

        $test->assert_not_null ($out);
        $test->assert_not_null ($out->{feature1});
        $test->assert_true ($out->{feature1}->{'1.0'});
        $test->assert_true ($out->{feature1}->{'2.0'});

    @@ImplNote:
      @@@lang:en
      @@@@:
        In current specifications of DOM, order of features are not 
        significant and treatement for dupulication of a feature name 
        is not specified.  
        If <P::features> in future levels of DOM does not 
        have this characteristic, this and some other implementation 
        must be revisited for that levels. 
        \
        This input normalizer creates a copy of feature list even if 
        it is given as a hash reference; it means that <QUOTE::breaking> 
        any parameter does not affect the input source. 

      {NOTE:: Feature <Feature::HTML> versions <FeatureVer::2.0>
              and <FeatureVer::5.0> are not compatible;
              it would be a use case for one feature name with
              multiple version numbers.
      }

  @ResourceDef:
    @@QName:
      DOMMain:stringifyFeatures
    @@rdf:type: DISPerl|BlockCode
    @@Description:
      @@@lang:en
      @@@@:
        Converts a manakai internal hash representation of <P::features> 
        (<PerlVar::$IN>) to a DOM standard string representation of it 
        (<PerlVar::$OUT>). 
        \
        Note that whether input is valid feature name-value pairs is 
        not checked; bad input will produce bad output.
    @@PerlDef:
      my @out;
      for my $fname (sort {$a cmp $b} keys %{$IN}) {
        for my $fver (sort {$a cmp $b} keys %{$IN->{$fname}}) {
          push @out, $fname;
          push @out, $fver if length $fver;
        }
      }
      $OUT = join ' ', @out;

    @@Test:
      @@@PerlDef:
        my $in = {
          core => {"3.0" => true, "1.0" => true},
          xml => {"" => true},
        };
        my $out;

        __CODE{DOMMain|stringifyFeatures::
          $IN => $in,
          $OUT => $out,
        }__;

        $test->assert_string
                 (actual_value => $out,
                  expected_value => "core 1.0 core 3.0 xml");

ElementTypeBinding:
  @Name: Test
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: test|StandaloneTest

ResourceDef:
  @QName: 
    ManakaiDOM:ManakaiDOMFeatures
  @For: ManakaiDOM|DOM3
  @AliasFor: FeaturesString

ResourceDef:
  @QName: Feature
  @FullName:
    @@lang:en
    @@@: DOM feature
  @rdf:type:
    rdfs:Class
  @rdfs:subClassOf:
    rdfs:Class::ManakaiDOM:all
  @For: =ManakaiDOM|all

ResourceDef:
  @QName:
    DOMMain:DOMFeature
  @For: =ManakaiDOM|all
  @AliasFor: Feature

## -- The feature system (manakai)

ElementTypeBinding:
  @Name: FeatureDef
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: Feature
    @@For: =ManakaiDOM|all

ElementTypeBinding:
  @Name: FeatureVerDef
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: Feature

ElementTypeBinding:
  @Name: featureQName
  @ElementType:
    f:name
  @ShadowContent:
    @@ContentType: DISCore|QName

PropDef:
  @QName: f|name
  @FullName:
    @@lang:en
    @@@: Feature name
  @rdfs:domain: f|Feature
  @dataType: DISCore|QName
  @multipleProperties: DISCore|UnorderedList

PropDef:
  @QName: version
  @FullName:
    @@lang:en
    @@@: Feature version
  @Description:
    @@lang:en
    @@@:
      A version number of a feature to define.
  @rdfs:domain: Feature
  @dataType: DISCore|String
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName:
    dis:Version
  @AliasFor: version
  @For: =ManakaiDOM|all

PropDef:
  @QName: provides
  @Description:
    @@lang:en
    @@@:
      The subject resource intends to provide a part 
      of the object feature. 
  @rdfs:domain: Feature
  @dataType: dis|TypeQName
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName: DOMMetaImpl|provideFeature
  @AliasFor: provides
  @For: =ManakaiDOM|all

PropDef:
  @QName: through
  @Description:
    @@lang:en
    @@@:
      The feature is provided through the object class. 
      \
      If this attribute is missing from a <Q::provideFeature>
      element and its parent is a <Q::ManakaiDOM:Class> definition,
      then that class with the current <QUOTE::for> is
      the <Q::providedThrough> class.
  @rdfs:domain:
    ManakaiDOM:Class
  @dataType: dis|TFQNames
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName: DOMMetaImpl|providedThrough
  @AliasFor: through
  @For: =ManakaiDOM|all

PropDef:
  @QName: implements
  @Description:
    @@lang:en
    @@@:
      A subject resource implements a object feature. 
  @rdfs:range: Feature
  @dataType: 
    dis:TypeQName
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName:
    DOMMain:implementFeature
  @AliasFor: implements
  @For: =ManakaiDOM|all

PropDef:
  @QName: instanceOf
  @Description:
    @@lang:en
    @@@:
      The subject feature is an instance of the object feature set.
  @rdfs:range: Feature
  @rdfs:domain: Feature
  @dataType: dis|TypeQName
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName: DOMMetaImpl|instanceFeatureOf
  @AliasFor: instanceOf
  @For: =ManakaiDOM|all

PropDef:
  @QName: extends
  @Description:
    @@lang:en
    @@@:
      The subject feature extends the object feature.
  @rdfs:range: Feature
  @rdfs:domain: Feature
  @dataType: dis|TypeQName
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName: DOMMetaImpl|extendFeature
  @AliasFor: extends
  @For: =ManakaiDOM|all

PropDef:
  @QName: requires
  @Description:
    @@lang:en
    @@@:
      A subject resource requires a object feature. 
  @rdfs:range: Feature
  @dataType:
    dis:TypeQName
  @multipleProperties: DISCore|UnorderedList

ResourceDef:
  @QName: 
    DOMMain:requireFeature
  @AliasFor: requires
  @For: =ManakaiDOM|all

## -- Roles

ResourceDef:
  @QName: DOMMetaImpl|ImplementationSourceForManakaiDOMImplementationRegistry
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @Description:
    @@lang:en
    @@@:
      If a class plays this <QUOTE::role>, then it must implement
      the <IF::DOMCore:DOMImplementationSource> interface with
      its two methods statically callable (i.e. they can be 
      called without any instance of the class).  Any class
      playing this <QUOTE::role> will be contacted when 
      the <M::ImplementationRegistry.getDOMImplementationList>
      method is called.

ResourceDef:
  @QName: DOMMetaImpl|ManakaiDOMImplementationSourceRole
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @rdfs:subClassOf:
    DOMMetaImpl|ImplementationSourceForManakaiDOMImplementationRegistry
  @Description:
    @@lang:en
    @@@:
      If a class plays this <QUOTE::role>, then it must implement
      the <IF::DOMCore:DOMImplementationSource> interface with
      its two methods statically callable (i.e. they can be 
      called without any instance of the class).  Any class
      playing this <QUOTE::role> will be contacted when 
      the <M::ImplementationRegistry.getDOMImplementationList>
      method is called.
      \
      {NOTE:: Whether the class implements the 
              <IF::DOMCore:ManakaiDOMImplementationSource> interface
              or not is another problem.
      \
      }

ResourceDef:
  @QName: DOMMetaImpl|ImplementationForManakaiDOMImplementationSource
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @Description:
    @@lang:en
    @@@:
      The <QUOTE::role> that instances of the class is available via
      the <IF::DOMCore:DOMImplementationSource> interface 
      implemented by the <Class::DOMCore:ManakaiDOMImplementationSource>
      objects.

ResourceDef:
  @QName: DOMMetaImpl|ImplementationCompatibleWithManakaiDOMMinimumImplementation
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @Description:
    @@lang:en
    @@@:
      The <QUOTE::role> that the class is compatible with the class
      <Class::ManakaiDOMMinimumImplementation> so that 
      any instance of the class compatible with it is castable 
      to the class via the <M::ManakaiDOMMinimumImplementation
      .getFeature> method.

ResourceDef:
  @QName: DOMMetaImpl|ManakaiAnyImplementationRole
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @rdfs:subClassOf: 
    DOMMetaImpl|ImplementationCompatibleWithManakaiDOMMinimumImplementation
  @Description:
    @@lang:en
    @@@:
      Any class that plays this <QUOTE::role> might be accessible 
      via <M::ManakaiDOMMinimumImplementation
            ::ManakaiDOM:ManakaiDOMLatest.getFeature>.
      \
      {NOTE:: The class don't have to implement the 
              <IF::DOMMinimumImplementation
                 ::ManakaiDOM:ManakaiDOMLatest> interface.
      \
      }

ResourceDef:
  @QName: DOMMetaImpl|ManakaiDOMImplementationRole
  @rdf:type:
    DISLang:Role
  @ForCheck:
    =ManakaiDOM:all
  @rdfs:subClassOf: DOMMetaImpl|ImplementationForManakaiDOMImplementationSource
  @rdfs:subClassOf: DOMMetaImpl|ManakaiAnyImplementationRole
  @Description:
    @@lang:en
    @@@:
      Any class that plays this <QUOTE::role> might be accessible
      via <Class::DOMCore:ManakaiDOMImplementationSource
                ::ManakaiDOM:ManakaiDOMLatest>
      or <M::DOMMetaImpl:ManakaiDOMMinimumImplementation
           ::ManakaiDOM:ManakaiDOMLatest.getFeature>.
      \
      {NOTE:: The class that plays this <QUOTE::role> must implement the
              <IF::DOMMetaImpl:ManakaiDOMMinimumImplementation
                 ::ManakaiDOM:ManakaiDOMLatest> interface.
      \
      }

PropDef:
  @QName:
    dis:Role
  @Description:
    @@lang:en
    @@@:
      A role of the subject class in the DOM system.  It identifies 
      what kind of classes should be provided as <QUOTE::alternative>s 
      via, for example, <M::DOMCore:DOMImplementation.getFeature>. 
      \
      {P:: Currently, its values includes: 
      \
        - <CODE::DOMEvents:ManakaiDOMEvent::ManakaiDOM:ManakaiDOMLatest>::: 
            Classes that should be available via 
            <M::DOMEvents:ManakaiDOMDocumentEvent.createEvent>.
      \
        - <CODE::DOMCore:DOMImplementation::ManakaiDOM:ManakaiDOM>::: 
            Classes that might be available via <Class::ImplementationRegistry>, 
            <IF::DOMCore:DOMImplementationSource> or 
            <M::DOMCore:DOMImplementation.getFeature>. 
      \
        - <CODE::DOMCore:DOMImplementationSource::ManakaiDOM:ManakaiDOM>:::
            Classes that should be known to 
            <Class::ImplementationRegistry>.
      \
        - <CODE::DOMCore:Node::ManakaiDOM:ManakaiDOM>::: 
            Classes that might be available via <M::DOMCore:Node.getFeature> 
            or any <IF::Node> returning method and attributes.
      \
      }
      \
      {NOTE:: <Q::dis:Role> is deprecated in favor of <Q::DISLang:role>;
              <Q::dis:Role> is retained here for compatibility 
              with old <CODE::cdis2pm> utility.
      \
      }
  @rdfs:domain:
    ManakaiDOM:Class
  @rdfs:range:
    ManakaiDOM:IF
  @dataType: dis|TFQNames
  @multipleProperties: DISCore|UnorderedList

PropDef:
  @QName:
    dis:compat
  @Description:
    @@lang:en
    @@@:
      The internal data structure (and so on) of a subject resource is 
      compatible with that of object resource. 
      \
      This property is described as a child element of 
      <Q::dis:Role> property element because of historical reason. 
      \
      {P:: Currently used its values are:
         \
         - <CODE::DOMCore:ManakaiDOMImplementation::ManakaiDOM:ManakaiDOMLatest>::: 
             An class that should be available via 
             <M::DOMCore:ManakaiDOMImplementation.getFeature>. 
         \
         - <CODE::DOMCore:ManakaiDOMImplementationSource::ManakaiDOM:ManakaiDOMLatest>:::
             An class that is able to handle as same manner 
             as <M::DOMCore:ManakaiDOMImplementationSource> by 
             <Class::ImplementationRegistry>.
         \
         - <CODE::DOMCore:ManakaiDOMNode::ManakaiDOM:ManakaiDOMLatest>:::
             An class that should be available via 
             <M::DOMCore:ManakaiDOMNode.getFeature>.
         \
      }
      \
      {NOTE:: <Q::dis:compat> is deprecated in favor of <Q::DISLang:role>;
              <Q::dis:compat> is retained here for compatibility 
              with old <CODE::cdis2pm> utility.
      \
      }
  @rdfs:domain:
    ManakaiDOM:Class
  @rdfs:range:
    ManakaiDOM:Class
  @dataType: dis|TFQNames
  @multipleProperties: DISCore|UnorderedList

## -- The bootstrap object

ResourceDef:
  @QName: ImplementationRegistryVar
  @rdf:type:
    DISPerl:ScalarVariable
  @DISPerl:variableName:
    Message::DOM::ImplementationRegistry
  @DefaultValue:
    @@@:
      <ClassName::ImplementationRegistry::ManakaiDOM:ManakaiDOMLatest>
    @@ContentType:
      lang:Perl
  @Type: DISPerl|String||ManakaiDOM|all
  @For:
    ManakaiDOM:ManakaiDOMLatest

ResourceDef:
  @QName: DEBUG
  @rdf:type: DISPerl|ScalarVariable
  @DISPerl:variableName:
    Message::DOM::DOMFeature::DEBUG
  @Type: DISPerl|Boolean||ManakaiDOM|all
  @For: ManakaiDOM|ManakaiDOMLatest
  @enDesc:
    The variable <Perl::$Message::DOM::DOMFeature::DEBUG> controls
    whether <M::ManakaiImplementationSource.getImplementation>
    should print debug message to the standard error output or not.
    If the variable is set to <DOM::true>, the process to find
    an implementation is shown so application developers can
    known what module should be loaded or what class is actually in use.
  @ForCheck: !ManakaiDOM|all

ElementTypeBinding:
  @Name: enDesc
  @ElementType:
    dis:Description
  @ShadowContent:
    @@lang:en

## -- The Minimum Implementation Specification

FeatureDef:
  @QName: min
  @FeatureVerDef:
    @@featureQName: fe|Min
    @@featureQName: ManakaiDOM|Minimum
    @@Version: 3.0
    @@QName: min30
    @@Description:
      @@@lang:en
      @@@@:
        Minimum DOM implementation, level 3.
    @@f:instanceOf: min

ElementTypeBinding:
  @Name: Doc
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@For: ManakaiDOM|ForSpec
    @@rdf:type: doc|Documentation

Doc:
  @QName: def|Document

  @enTitle:
    Document Object Model (DOM) Minimum Implementation Level 3
  @doc:shortTitle:
    @@lang:en
    @@@:
      DOM Minimum Implementation Level 3

  @rdf:type: doc|Document

  @doc:author: DISCore|Wakaba

  @doc:part:
    @@@: def|Abstract
    @@doc:rel: doc|abstract
    @@doc:rel: doc|additionalSection

  @doc:part:
    @@@: def|Status
    @@doc:rel: doc|status
    @@doc:rel: doc|additionalSection

  @doc:part:
    @@@: def|TOC
    @@doc:rel: doc|shortTOC
    @@doc:rel: doc|additionalSection

  @doc:part:
    @@@: def|expandedTOC
    @@doc:rel: doc|longTOC
    @@doc:rel: doc|additionalSection
    @@doc:rel: f|Chapter

  @doc:part:
    @@@: def|MinImpl
    @@doc:rel: doc|mainSection
    @@doc:rel: f|Chapter

  @doc:part:
    @@@: def|IDLDefinitions
    @@doc:rel: f|IDLDefinitions
    @@doc:rel: doc|appendix
    @@doc:rel: f|Chapter
  @doc:part:
    @@@: def|JavaBinding
    @@doc:rel: f|JavaBinding
    @@doc:rel: doc|appendix
    @@doc:rel: f|Chapter
  @doc:part:
    @@@: def|ECMAScriptBinding
    @@doc:rel: f|ECMAScriptBinding
    @@doc:rel: doc|appendix
    @@doc:rel: f|Chapter
  @doc:part:
    @@@: def|PerlBinding
    @@doc:rel: f|PerlBinding
    @@doc:rel: doc|appendix
    @@doc:rel: f|Chapter

  @doc:part:
    @@@: def|References
    @@doc:rel: doc|references
    @@doc:rel: doc|additionalSection
    @@doc:rel: f|Chapter

  @doc:part:
    @@@: def|Index
    @@doc:rel: doc|index
    @@doc:rel: doc|additionalSection
    @@doc:rel: f|Chapter

  @FileName: Overview

ResourceDef:
  @QName: f|IDLDefinitions
  @For: =ManakaiDOM|all
  @rdf:type: rdfs|Resource

ResourceDef:
  @QName: f|JavaBinding
  @For: =ManakaiDOM|all
  @rdf:type: rdfs|Resource

ResourceDef:
  @QName: f|ECMAScriptBinding
  @For: =ManakaiDOM|all
  @rdf:type: rdfs|Resource

ResourceDef:
  @QName: f|PerlBinding
  @For: =ManakaiDOM|all
  @rdf:type: rdfs|Resource

ResourceDef:
  @QName: f|Chapter
  @For: =ManakaiDOM|all
  @rdf:type: rdfs|Resource

ElementTypeBinding:
  @Name: enContent
  @ElementType:
    doc:content
  @ShadowContent:
    @@lang:en
    @@ForCheck: ManakaiDOM|ForSpec

ElementTypeBinding:
  @Name: enTitle
  @ElementType:
    doc:title
  @ShadowContent:
    @@lang:en
    @@ForCheck: ManakaiDOM|ForSpec

Doc:
  @QName: def|Abstract
  @enContent:
    This specification defines the Document Object Model
    Minimum Implementation Level 3, a set of interface
    that allows applications to dynamically obtain
    implementations of DOM or any other object model.

Doc:
  @QName: def|Status

Doc:
  @QName: def|TOC
  @doc:part: f|ShortTOC||ManakaiDOM|all

Doc:
  @QName: def|expandedTOC
  @doc:part: f|LongTOC||ManakaiDOM|all

  @FileName: expanded-toc

ResourceDef:
  @QName: f|ShortTOC
  @rdf:type: rdfs|Resource
  @For: =ManakaiDOM|all

ResourceDef:
  @QName: f|LongTOC
  @rdf:type: rdfs|Resource
  @For: =ManakaiDOM|all

Doc:
  @QName: def|MinImpl

  @enTitle: Document Object Model Minimum Implementation
  @doc:shortTitle:
    @@lang:en
    @@@:
      DOM Minimum Implementation

  @doc:part:
    @@@: def|Introduction
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|Definitions
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|Interfaces
    @@doc:rel: doc|subsection

  @FileName: minimpl

Doc:
  @QName: def|Introduction
  @enTitle: Introduction

Doc:
  @QName: def|Definitions
  @enTitle: Definitions

  @doc:part:
    @@@: def|MIString
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|FeatureNameString
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|FeatureVersionString
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|FeaturesString
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|ImplRegDescription
    @@doc:rel: doc|subsection

Doc:
  @QName: def|Interfaces
  @enTitle: Interfaces

  @doc:part:
    @@@: f|ImplementationList
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|ImplementationSource
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|MinimumImplementation
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: f|GetFeature
    @@doc:rel: doc|subsection

Doc:
  @QName: def|IDLDefinitions

  @enContent:
    This appendix comtains the complete OMG IDL <SRC::OMG IDL> for the
    Level 3 Document Object Model Minimum Implementation definitions.

  # The IDL files are also available as: <idl.zip>.

  @doc:part:
    @@@: MDOM|DOMFeature
    @@doc:as: idl|File

  @FileName: idl-definitions

Doc:
  @QName: def|JavaBinding
  @FileName: java-binding

  @enContent:
    This appendix contains the complete Java binding for the
    Level 3 Document Object Model Minimum Implementation.

  @doc:part:
    @@@: def|MIStringJava
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|ImplRegJava
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: MDOM|DOMFeature
    @@doc:as: j|Package
    @@doc:rel: doc|subsection

Doc:
  @QName: def|ECMAScriptBinding
  @FileName: ecma-script-binding

  @enContent:
    This appendix contains the complete ECMAScript binding for the
    Level 3 Document Object Model Minimum Implementation.

  @doc:part:
    @@@: def|MIStringECMAScript
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|ImplRegECMAScript
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: MDOM|DOMFeature
    @@doc:as: f|ECMAScriptBindingDefinition
    @@doc:rel: doc|subsection

ResourceDef:
  @QName: f|ECMAScriptBindingDefinition
  @rdf:type: rdfs|Class

Doc:
  @QName: def|PerlBinding
  @FileName: perl-binding

  @enContent:
    This appendix contains the complete Perl binding for the
    Level 3 Document Object Model Minimum Implementation.

  @doc:part:
    @@@: def|PerlTypes
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|MIStringPerl
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|PerlInterfaces
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|PerlMethods
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|PerlExceptions
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|ImplRegPerl
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: MDOM|DOMFeature
    @@doc:as: f|PerlBindingDefinition
    @@doc:rel: doc|subsection

Doc:
  @QName: def|PerlTypes
  @enTitle: Basic Data Types
  @enContent:
    For Perl, IDL types <TYPE^^DISCore|QName::idl|long>,
    <TYPE^^DISCore|QName::idl|unsignedLong>,
    <TYPE^^DISCore|QName::idl|unsignedLongLong>,
    <TYPE^^DISCore|QName::idl|short>, and
    <TYPE^^DISCore|QName::idl|unsignedShort> are bound to number value.
    This does not means that a parameter value whose type is e.g. 
    <TYPE^^DISCore|QName::idl|unsignedLong> must be a Perl scalar value whose
    internal representation has number value.  Rather,
    it should be interpreted as the value would be 
    evaluated in the number context.  For example, the
    value obtained from a string literal <Perl::"123">
    in the source code is a valid value of
    <TYPE^^DISCore|QName::idl|unsignedLong>
    parameter.  Similary, IDL type <TYPE^^DISCore|QName::idl|boolean>
    is expected to be evaluated in the Boolean context.

    IDL type <TYPE^^DISCore|QName::idl|any> is corresponding to any scalar value
    in Perl.  IDL type <TYPE^^DISCore|QName::idl|Object> is bound to object.

    The <DOM::null> value is bound to <Perl::undef>.

Doc:
  @QName: def|PerlInterfaces
  @enTitle: Interfaces, Modules and Constants
  @enContent:
    {TODO:: tbd
    }

Doc:
  @QName: def|PerlMethods
  @enTitle: Methods and Attributes in Perl Binding
  @enContent:
    In Perl, DOM methods and attributes are implemented
    as methods.  Read-only attributes are methods with no
    parameter in Perl.  Read-write attributes are methods
    with one parameter.  If the parameter is specified, then
    an attribute value is set to the value.  Otherwise, 
    the method returns the attribute value.  Note that the
    parameter value might be <DOM::null> and it is different
    from not specifying the parameter.

    A parameter of any method is <DFN::optional> if 
    either <DOM::null> or Boolean <DOM::false> is a possible value
    for the parameter and any other parameters following it, if any,
    is all optional.  Applications don't have to specify
    optional parameters if their values are <DOM::null> or <DOM::false>.

Doc:
  @QName: def|PerlExceptions
  @enTitle: Exceptions
  @enContent:
    Some methods and attributes might throw exceptions.  In Perl,
    throwing an exception is done by the function <Perl::die>.
    To improve compatibility among implementations, the
    <Class::dx:Error||ManakaiDOM|Perl> module <kwd:SHOULD>
    be employed as a basis of exception throwing mechanism.

ResourceDef:
  @QName: f|PerlBindingDefinition
  @rdf:type: rdfs|Class

Doc:
  @QName: def|References

  @doc:part:
    @@@: def|NormativeReferences
    @@doc:rel: doc|normativeReferences
    @@doc:rel: doc|subsection
  @doc:part:
    @@@: def|InformativeReferences
    @@doc:rel: doc|informativeReferences
    @@doc:rel: doc|subsection

  @FileName: references

Doc:
  @QName: def|NormativeReferences

Doc:
  @QName: def|InformativeReferences

Doc:
  @QName: def|Index
  @doc:part: f|Index||ManakaiDOM|all

  @FileName: def-index

ResourceDef:
  @QName: f|Index
  @rdf:type: rdfs|Resource
  @For: =ManakaiDOM|all

Doc:
  @QName: def|MIString
  @enTitle:
    The <TYPE::MIString> Type
  @enContent:
    The <TYPE::MIString> type is used to store character.
  @doc:part: f|MIString

ResourceDef:
  @QName: MIString
  @For: ManakaiDOM|DOM
  @Label:
    @@lang:en
    @@@:
      <DOM::MIString>
  @rdf:type: idl|IDLDataType
  @rdf:type: idl|ValueType

  @rdfs:subClassOf: DISLang|String||ManakaiDOM|all

  @enDesc:
    A <TYPE::MIString> is a sequence of characters.  How
    the characters are represented is implementation dependent.

  @idl:sequenceOf: idl|unsignedShort
  @idl:java: jlang|String
  @idl:ecmascript: js|StringType
  @idl:perl: p|CharacterString

Doc:
  @QName: def|MIStringJava
  @enTitle:
    The <TYPE::MIString> Type
  @enContent:
    For Java, <TYPE::MIString> is bound to the <Java::String> class,
    which is a sequence of UTF-16's 16-bit code units.

Doc:
  @QName: def|MIStringECMAScript
  @enTitle:
    The <TYPE::MIString> Type
  @enContent:
    For Perl, <TYPE::MIString> is bound to the <JS::String> type,
    which is a sequence of UTF-16's 16-bit code units.

Doc:
  @QName: def|MIStringPerl
  @enTitle:
    The <TYPE::MIString> Type
  @enContent:
    The <TYPE::MIString> type is bound to Perl string value and
    expected to be evaluated in the string context.  A <TYPE::MIString>
    value <kwd:MUST> be interpreted as a sequence of characters rather than
    a sequence of bytes or octets.  If it is represented
    internally as a byte string, i.e. the utf8 flag turned off,
    it <kwd:MUST> be interpreted as a ISO/IEC 8859-1 <bibref::ISO8859-1> string.

## -- The implementation registry object

ResourceDef:
  @QName:
    @@@: ImplementationRegistry
    @@ForCheck: !ManakaiDOM|ForSpec
  @QName: 
    @@@: def|ImplRegDescription
    @@ForCheck: ManakaiDOM|ForSpecAll
  @QName: 
    @@@: def|ImplRegJava
    @@ForCheck: ManakaiDOM|ForSpecJava
  @QName: 
    @@@: def|ImplRegECMAScript
    @@ForCheck: ManakaiDOM|ForSpecECMAScript
  @QName: 
    @@@: def|ImplRegPerl
    @@ForCheck: ManakaiDOM|ForSpecPerl

  @enTitle:
    The <CODE::ImplementationRegistry> Object

  @rdf:type:
    @@@@: DISLang|Class
    @@@ForCheck: ManakaiDOM|ManakaiDOM

  @rdf:type:
    @@@@: dis|MultipleResource
    @@@ForCheck:
      ManakaiDOM|ForSpec !ManakaiDOM|ForSpecJava !ManakaiDOM|ForSpecAll
      !ManakaiDOM|ForSpecPerl !ManakaiDOM|ForSpecECMAScript
  @resourceFor: ManakaiDOM|ForSpecAll
  @resourceFor: ManakaiDOM|ForSpecJava
  @resourceFor: ManakaiDOM|ForSpecECMAScript
  @resourceFor: ManakaiDOM|ForSpecPerl

  @rdf:type:
    @@@@: doc|Documentation
    @@@ForCheck: ManakaiDOM|ForSpecAll
  @rdf:type:
    @@@@: doc|Documentation
    @@@ForCheck: ManakaiDOM|ForSpecJava
  @rdf:type:
    @@@@: doc|Documentation
    @@@ForCheck: ManakaiDOM|ForSpecECMAScript
  @rdf:type:
    @@@@: doc|Documentation
    @@@ForCheck: ManakaiDOM|ForSpecPerl

  @For: ManakaiDOM|DOM3
  @For: ManakaiDOM|ForSpec3

  @Implement: ImplementationSource||ManakaiDOM|ManakaiDOM3
  @Implement:
    @@@: ImplementationSource||ManakaiDOM|ManakaiDOMLatest
    @@For: ManakaiDOM|ManakaiDOMLatest

  @enContent:
    @@ForCheck: ManakaiDOM|ForSpecAll
    @@@:
    DOM Level 3 Core specification introduces a <CODE::DOMImplementationRegistry>
    object with a function that lets an application find DOM
    implementations, based on the specific features it requires.
    DOM Level 3 Minimum Implementation defines a more generalized
    <CODE::ImplementationRegistry> object, with which an application
    can find implementations that supports specific features.

    How this object is found and what it exactly looks like is 
    not defined here, because this cannot done in a
    language-independent manner.  Instead, each language binding
    defines its own way of doing this.  The object
    <kwd:MUST> implement the <IF::ImplementationSource>
    interface.

  @enContent:
    @@ForCheck: ManakaiDOM|ForSpecJava
    @@@:
      The <Java::ImplementationRegistry> is first initialized by 
      the application or the implementation, depending on the context, 
      through the Java system property
      <Java::cx.fam.suika.manakai.ImplementationSourceList>.
      The value of this property is a space separated list of
      names of available classes implementing the 
      <IF::ImplementationSource> interface.

      {TODO:: Defines the class and clarifies the relationship
              to <Java::DOMImplementationRegistry> object.
      }

  @enContent:
    @@ForCheck: ManakaiDOM|ForSpecECMAScript
    @@@:
      In ECMAScript binding, the global scope object
      has the <JS::ImplementationRegistry> property whose value
      is an object which implements
      the <IF::ImplementationSource> interface.

      {TODO:: How the object finds implementations?
      }

  @enContent:
    @@ForCheck: ManakaiDOM|ForSpecPerl
    @@@:
      In Perl binding, the scalar variable 
      <Perl::$Message::DOM::ImplementationRegistry> has a reference
      with which methods defined in <IF::ImplementationSource> interface
      can be called.

        {NOTE:: The variable value might be a package name
                rather than a hard reference.
        }

      {TODO:: Describes how the object finds implementations.
      }

  @Description:
    @@lang:en
    @@@:
      A binding dependent bootstrap for <IF::MinimumImplementation> objects.
  @Description:
    @@For:
      ManakaiDOM:ManakaiDOM
    @@lang:en
    @@@:
      A bootstrap class/object from which DOM implementations can be 
      retrieved.  For the manakai
      <Class::ImplementationRegistry> 
      implementation, DOM applications can access the registry both 
      via class methods and via object methods.  That is, applications 
      are free, but need not to instantiate a 
      <Class::ImplementationRegistry> object to get 
      DOM implementations. 
      \
      {NOTE:: Authors of DOM applications will usually want to access 
              the registry by the means of class methods (i.e. no 
              instance objects), since most applications don't 
              require more than one implementations.
      \
      }

  @Method:
     @@Name:  getImplementation
     @@ManakaiDOM:isStatic: 1
     @@Description:
       @@@lang:en
       @@@@:
         Seeks and returns the first implementation that implements 
         desired features. 
     @@Param:
        @@@Name:  features
        @@@Type:  MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@: 
            A list of desired features that must be implemented.
     @@Return:
       @@@Type: MinimumImplementation
       @@@enDesc:
         The first implementation that has the desired features.
         The object returned by this method may not implement
         the <IF::DOMCore:DOMImplementation> interface.
       @@@enDesc:
         @@@@For: ManakaiDOM|ManakaiDOM
         @@@@@:
           {NOTE:: The object returned by this method might not
                   be a manakai object.
           }
       @@@InCase:
         @@@@Value:
           @@@@@is-null:1
         @@@@Description:
           @@@@@lang:en
           @@@@@@: 
             No implementation implementing the desired features is found.
       @@@PerlDef:
           __CODE{DOMMain:stringifyFeatures:: $IN => $features,
                                              $OUT => $features}__;
           __DEEP{
             C: for my $class (
               keys %Message::DOM::ManakaiDOMImplementationRegistry::SourceClass
             ) {
               if ($class->isa (<IFName::ImplementationSource>)) {
                 $r = $class-><M::ImplementationSource
                               .getImplementation> ($features);
               } else {
                 $r = $class-><M::ImplementationSource
                               .getDOMImplementation> ($features);
               }
               last C if defined $r;
             }
           }__;
      @@@ImplNote:
        @@@@lang:en
        @@@@@:
          Converting <P::features> into a string is necessary since 
          a <IF::DOMCore:DOMImplementationSource> might not be part 
          of manakai so that it does not support the hash representation. 

  @Method:
     @@Name:  getDOMImplementation
     @@ManakaiDOM:isStatic: 1
     @@Description:
       @@@lang:en
       @@@@:
         Seeks and returns the first implementation that implements 
         desired features. 
     @@Param:
        @@@Name:  features
        @@@Type:  MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@: 
            A list of desired features that must be implemented.
     @@Return:
       @@@Type: MinimumImplementation
       @@@enDesc:
         The first DOM implementation that has the desired features.
         The object returned by this method <kwd:MUST> implement
         the <IF::DOMCore:DOMImplementation> interface defined
         in DOM Level 3 and it <kwd:MUST> has the feature
         <Feature::Core> version <FeatureVer::3.0>.
       @@@enDesc:
         @@@@For: ManakaiDOM|ManakaiDOM
         @@@@@:
           {NOTE:: The object returned by this method might not
                   be a manakai object.
           }
       @@@InCase:
         @@@@Value:
           @@@@@is-null:1
         @@@@Description:
           @@@@@lang:en
           @@@@@@: 
             No implementation implementing the desired features is found.
       @@@PerlDef:
           $features->{core}->{'3.0'} = true;
           __CODE{DOMMain:stringifyFeatures:: $IN => $features,
                                              $OUT => $features}__;
           __DEEP{
             C: for my $class (
               keys %Message::DOM::ManakaiDOMImplementationRegistry::SourceClass
             ) {
               $r = $class-><M::ImplementationSource
                               .getDOMImplementation> ($features);
               last C if defined $r;
             }
           }__;
      @@@ImplNote:
        @@@@lang:en
        @@@@@:
          Converting <P::features> into a string is necessary since 
          a <IF::DOMCore:DOMImplementationSource> might not be part 
          of manakai so that it does not support the hash representation. 

  @Method:
     @@Name:  getImplementationList
     @@ManakaiDOM:isStatic: 1
     @@Description:
       @@@lang:en
       @@@@:
         Returns a list of all the implementations that implement 
         desired features.
     @@Param:
        @@@Name:  features
        @@@Type:  MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@: A list of desired features that must be implemented.
     @@Return:
       @@@Type:  ImplementationList
       @@@actualType: ManakaiImplementationList
       @@@Description:
         @@@@lang:en
         @@@@@: 
           A list of implementations that support the desired features. 
           The object returned by this method might not implement
           the <IF::DOMCore:DOMImplementation> interface.

           {NOTE:: Since implementation sources reports the same
                   implementation, the list <kwd:MAY> contain an implementation
                   more than one times.
           }
       @@@enDesc:
         @@@@For: ManakaiDOM|ManakaiDOM
         @@@@@:
           {NOTE:: Although the list returned by this method itself
                   is a manakai object, each item in the list might
                   not a manakai object.
           }
       @@@PerlDef:
           __CODE{DOMMain:stringifyFeatures:: $IN => $features,
                                              $OUT => $features}__;
           __DEEP{
             $r = <Class::ManakaiImplementationList>->new;
             for my $class (
               keys %Message::DOM::ManakaiDOMImplementationRegistry::SourceClass
             ) {
               if ($class->isa (<IFName::ImplementationSource>)) {
                 $r-><M::ImplementationList.appendItems>
                         ($class-><M::ImplementationSource
                                       .getImplementationList> ($features));
               } else {
                 $r-><M::ImplementationList.appendItems>
                         ($class-><M::ImplementationSource
                                       .getDOMImplementationList> ($features));
               }
             }
           }__;

  @Method:
     @@Name:  getDOMImplementationList
     @@ManakaiDOM:isStatic: 1
     @@Description:
       @@@lang:en
       @@@@:
         Returns a list of all the DOM implementations that implement 
         desired features.
     @@Param:
        @@@Name:  features
        @@@Type:  MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@: A list of desired features that must be implemented.
     @@Return:
       @@@Type:  ImplementationList
       @@@actualType: ManakaiImplementationList
       @@@Description:
         @@@@lang:en
         @@@@@: 
           A list of DOM implementations that support the desired features. 
           The object returned by this method <kwd:MUST> implement
           the <IF::DOMCore:DOMImplementation> interface defined
           in DOM Level 3 and it <kwd:MUST> has the feature
           <Feature::Core> version <FeatureVer::3.0>.

           {NOTE:: Since implementation sources reports the same
                   implementation, the list <kwd:MAY> contain an implementation
                   more than one times.
           }
       @@@enDesc:
         @@@@For: ManakaiDOM|ManakaiDOM
         @@@@@:
           {NOTE:: Although the list returned by this method itself
                   is a manakai object, each item in the list might
                   not a manakai object.
           }
       @@@PerlDef:
           $features->{core}->{'3.0'} = true;
           __CODE{DOMMain:stringifyFeatures:: $IN => $features,
                                              $OUT => $features}__;
           __DEEP{
             $r = <Class::ManakaiImplementationList>->new;
             for my $class (
               keys %Message::DOM::ManakaiDOMImplementationRegistry::SourceClass
             ) {
               $r-><M::ImplementationList.appendItems>
                         ($class-><M::ImplementationSource
                                       .getDOMImplementationList> ($features));
             }
           }__;
##ImplementationRegistry

## -- DOM implementation list & source modeled from DOM Level 3 Core module

ElementTypeBinding:
  @Name: minIFClsDef
  @ElementType: 
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type:
      @@@@: dis|MultipleResource
      @@@ForCheck: !ManakaiDOM|ForIF !ManakaiDOM|ForClass
    @@resourceFor: ManakaiDOM|ForIF
    @@resourceFor:
      @@@@: ManakaiDOM|ForClass
      @@@ForCheck: ManakaiDOM|ManakaiDOM !=ManakaiDOM|ManakaiDOM
    @@For: ManakaiDOM|DOM3
    @@For: =ManakaiDOM|ManakaiDOM
    @@For: ManakaiDOM|ForSpecLatest

    @@rdf:type:
      @@@@: DISLang|Interface
      @@@ForCheck: ManakaiDOM|ForIF ManakaiDOM|ManakaiDOM

    @@rdf:type:
      @@@@: idl|Interface
      @@@ForCheck: ManakaiDOM|ForIF ManakaiDOM|ForSpecLatest

    @@rdf:type:
      @@@@: DISLang|Class
      @@@ForCheck: ManakaiDOM|ForClass
    @@Implement:
      @@@@: ||ManakaiDOM|ManakaiDOM||ManakaiDOM|ForIF
      @@@ContentType: DISCore|TFPQNames
      @@@ForCheck: ManakaiDOM|ForClass ManakaiDOM|ManakaiDOM
    @@Implement:
      @@@@: ||ManakaiDOM|ManakaiDOM3||ManakaiDOM|ForIF
      @@@ContentType: DISCore|TFPQNames
      @@@ForCheck: ManakaiDOM|ForClass ManakaiDOM|ManakaiDOM3
    @@Implement:
      @@@@: ||ManakaiDOM|ManakaiDOMLatest||ManakaiDOM|ForIF
      @@@ContentType: DISCore|TFPQNames
      @@@ForCheck: ManakaiDOM|ForClass ManakaiDOM|ManakaiDOMLatest

    @@DOMMain:implementFeature: min30

minIFClsDef:
  @IFQName: ImplementationList
  @ClsQName: ManakaiImplementationList

  @enDesc:
    An ordered collection of objects which implement the
    <IF::MinimumImplementation> interface.

    {NOTE:: How this collection is implemented is unspecified.
    }

    {NOTE:: This collection is <EM::not> <QUOTE::live>.
    }
  @enDesc:
    @@@:
      In the Perl binding, the <IF::ImplementationList> objects
      might be handled as if they are arrays.
  
  @Method:
     @@Name:  item
    @@Operator: DISLang|ArrayGet
     @@Description:
       @@@lang:en
       @@@@: 
         Returns the <P::index>th item in this collection.
     @@Param:
        @@@Name:  index
        @@@Type:  
          DOMMain:unsigned-long::ManakaiDOM:all
        @@@Description:
          @@@@lang:en
          @@@@@: 
            An index of the item to retrieve in this collection.
     @@Return:
        @@@Type: MinimumImplementation
        @@@Description:
          @@@@lang:en
          @@@@@: 
            The implementation at the <P::index>th position in
            the collection.
        @@@InCase:
          @@@@Value: 
            @@@@@is-null:1
          @@@@Description:
            @@@@@lang:en
            @@@@@@:
              There is no <P::index>th implementation in the collection.
        @@@PerlCDef:
          if (not defined $index or
              $index < 0 or
              $index > $#$self) {
            $r = null;
          } else {
            $r = $self->[$index];
          }
  @Attr:
     @@Name:  length
     @@Description:
       @@@lang:en
       @@@@:  
         The number of implementation objects in the collection.
     @@Get:
        @@@Type:  
          DOMMain:unsigned-long::ManakaiDOM:all
        @@@PerlCDef:
            $r = @$self;

  @Method:
    @@Operator:
      @@@@: DISPerl|NewMethod
      @@@ContentType: dis|TypeQName
    @@ManakaiDOM:isStatic:1
    @@ManakaiDOM:isForInternal:1
    @@ForCheck: ManakaiDOM|ForClass
    @@enDesc:
      Creates a new <IF::ImplementationList> object and returns it.
    @@Return:
      @@@Type: ImplementationList
      @@@actualType: ManakaiImplementationList
      @@@enDesc: The newly created list.
      @@@PerlDef:
          $r = bless [], ref $self ? ref $self : $self;
  @Method:
    @@Name: appendItems
    @@enDesc:
      Appends a list of implementations after the last item
      in the collection.

      {NOTE:: This method is provided for the convinience of
              <IF::ImplementationSource>s.
      }
    @@Param:
      @@@Name: list
      @@@Type: ImplementationList
      @@@enDesc:
        A list of implementations.
      @@@enDesc:
        @@@@For: ManakaiDOM|Perl
        @@@@For: ManakaiDOM|ForSpec
        @@@@@:
          In the Perl binding, the parameter value <kwd:MAY> be 
          a <IF::MinimumImplementation> object.
    @@Return:
      @@@PerlCDef:
        if ($list->isa (<IFName::ImplementationList>)) {
          push @$self, @$list;
        } else {
          push @$self, $list;
        }
##ImplementationList

minIFClsDef:
  @IFQName: ImplementationSource
  @ClsQName: ManakaiImplementationSource
  
  @DISLang:role: DOMMetaImpl|ManakaiDOMImplementationSourceRole

  @enDesc:
    The objects implementing <IF::ImplementationSource> interface provides 
    access to available implementations.  The 
    <Class::ImplementationRegistry> object is a special case
    of the instance of this interface.

  @Method:
     @@Name:  getImplementation
     @@Description:
        @@@lang:en
        @@@@: 
          Returns the first implementation that support specific 
          features.
     @@Param:
        @@@Name:  features
        @@@Type: MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A string that specifies which features and versions are 
            required.
     @@Return:
        @@@Type:MinimumImplementation
        @@@Description:
          @@@@lang:en
          @@@@@: 
            The first implementation that support the desired 
            features and versions.
        @@@InCase:
          @@@@Value:
            @@@@@is-null:1
          @@@@Description:
            @@@@@lang:en
            @@@@@@: 
              This source has no implementation that supports the 
              desired features and versions.
        @@@PerlCDef:
            my $debug = $Message::DOM::DOMFeature::DEBUG
                      ? sub ($@) { print STDERR (('  ' x shift), @_) }
                      : sub ($@) {};
            CLS: for my $class (grep {
              $Message::DOM::ManakaiDOMImplementationSource::SourceClass{$_}
            } keys %Message::DOM::ManakaiDOMImplementationSource::SourceClass) {
              $debug->(1, qq<Class "$class"...\n>);
              __CODE{makeClassISAList:: $CLASS => $class}__;
              for my $fname (keys %$features) {
                my $fkey = $fname;
                my $plus = $fname =~ s/^\+// ? true : false;
                $debug->(2, qq<Feature "$fname">, ($plus?'+':''), qq<,\n>);
                FVER: for my $fver (grep {$features->{$fkey}->{$_}}
                                       keys %{$features->{$fkey}}) {
                  $debug->(3, qq<version "$fver"...\n>);
                  for my $cls ($class, @{$Message::DOM::ClassISA{$class}}) {
                    if ($Message::DOM::ImplFeature{$class}->{$fname}->{$fver} ||=
                           ## (Caching)
                        $Message::DOM::ImplFeature{$cls}->{$fname}->{$fver}) {
                      $debug->(4, qq<found in "$cls"\n>);
                      next FVER; # Feature/version found
                    }
                  }

                  if ($plus) {
                    if ($Message::DOM::ManakaiDOMImplementation::CompatClass{
                          $class}) {
                      my %compat_cls;
                      for my $cls (grep {
                        $Message::DOM::ManakaiDOMImplementation::CompatClass{
                        $_}
                      } keys
                      %Message::DOM::ManakaiDOMImplementation::CompatClass) {
                        next if $compat_cls{$cls};
                        __CODE{makeClassISAList:: $CLASS => $cls}__;
                        for my $c (@{$Message::DOM::ClassISA{$cls}}) {
                          $compat_cls{$c} = true;
                        }                 
                      }
                      for my $cls (keys %compat_cls) {
                        if ($Message::DOM::ImplFeature{$cls}
                              ->{$fname}->{$fver}) {
                          $debug->(4, qq<found+ in "$cls"\n>);
                          next FVER; # +Feature/ver found
                        }
                      }
                    }
                  }
                  $debug->(2, qq<not found\n>);
                  next CLS; # Not found
                } # FVER
              } # FNAME

              ## Class found
              $r = $class->_new;
              last CLS;    ## NOTE: Method name directly written
            } # CLS

  @Method:
     @@Name:  getDOMImplementation
     @@Description:
        @@@lang:en
        @@@@: 
          Returns the first DOM implementation that support specific 
          features.

          {NOTE:: An implementation supports the DOM if 
                  it supports the <Feature::Core> feature.
                  In the <IF::ImplementationSource> objects
                  implementing the <Feature::ManakaiDOM|Minimum>
                  version <FeatureVer::3.0>, a DOM implementation
                  <kwd:MUST> support the <Feature::Core> feature
                  version <FeatureVer::3.0>.
          }
     @@Param:
        @@@Name:  features
        @@@Type: MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A string that specifies which features and versions are 
            required.
     @@Return:
        @@@Type:MinimumImplementation
        @@@Description:
          @@@@lang:en
          @@@@@: 
            The first DOM implementation that support the desired 
            features and versions.
        @@@InCase:
          @@@@Value:
            @@@@@is-null:1
          @@@@Description:
            @@@@@lang:en
            @@@@@@: 
              This source has no DOM implementation that supports the 
              desired features and versions.
        @@@PerlCDef:
          $features->{'core'}->{'3.0'} = true;
          __DEEP{
            $r = $self-><M::ImplementationSource.getImplementation> ($features);
          }__;

  @Method:
     @@Name:  getImplementationList
     @@Description:
       @@@lang:en
       @@@@:
         Returns a list of implementations that support the specified 
         features and versions.
     @@Param:
        @@@Name:  features
        @@@Type: MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A string that specifies which features and versions are required.
     @@Return:
        @@@Type:  ImplementationList
        @@@actualType: ManakaiImplementationList
        @@@Description:
          @@@@lang:en
          @@@@@:
            A list of implementations that support the desired 
            features and versions.
        @@@PerlCDef:
            $r = <ClassName::ManakaiImplementationList>->new;
            CLS: for my $class (grep {
              $Message::DOM::ManakaiDOMImplementationSource::SourceClass{$_}
            } keys %Message::DOM::ManakaiDOMImplementationSource::SourceClass) {
              __CODE{makeClassISAList:: $CLASS => $class}__;
              for my $fname (keys %$features) {
                my $fkey = $fname;
                my $plus = $fname =~ s/^\+// ? true : false;
                FVER: for my $fver (grep {$features->{$fkey}->{$_}}
                                       keys %{$features->{$fkey}}) {
                  for my $cls ($class, @{$Message::DOM::ClassISA{$class}}) {
                    if ($Message::DOM::ImplFeature{$class}->{$fname}->{$fver} ||=
                           ## (Caching)
                        $Message::DOM::ImplFeature{$cls}->{$fname}->{$fver}) {
                      next FVER; # Feature/version found
                    }
                  }

                  if ($plus) {
                    if ($Message::DOM::ManakaiDOMImplementation::CompatClass{
                          $class}) {
                      my %compat_cls;
                      for my $cls (grep {
                        $Message::DOM::ManakaiDOMImplementation::CompatClass{
                        $_}
                      } keys
                      %Message::DOM::ManakaiDOMImplementation::CompatClass) {
                        next if $compat_cls{$cls};
                        __CODE{makeClassISAList:: $CLASS => $cls}__;
                        for my $c (@{$Message::DOM::ClassISA{$cls}}) {
                          $compat_cls{$c} = true;
                        }                 
                      }
                      for my $cls (keys %compat_cls) {
                        if ($Message::DOM::ImplFeature{$cls}
                              ->{$fname}->{$fver}) {
                          next FVER; # +Feature/ver found
                        }
                      }
                    }
                  }
                  next CLS; # Not found
                } # FVER
              } # FNAME

              ## Class found
              push @$r, $class->_new;
              last CLS;                 ## NOTE: Method name directly written
            } # CLS

  @Method:
     @@Name:  getDOMImplementationList
     @@Description:
       @@@lang:en
       @@@@:
         Returns a list of DOM implementations that support the specified 
         features and versions.
     @@Param:
        @@@Name:  features
        @@@Type: MIString
        @@@actualType: FeaturesString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A string that specifies which features and versions are required.
     @@Return:
        @@@Type:  ImplementationList
        @@@actualType: ManakaiImplementationList
        @@@Description:
          @@@@lang:en
          @@@@@:
            A list of DOM implementations that support the desired 
            features and versions.
        @@@PerlCDef:
          __DEEP{
            $features->{core}->{'3.0'} = true;
            $r = $self-><M::ImplementationSource
                           .getImplementationList> ($features);
          }__;
##ImplementationSource

ResourceDef:
  @QName: makeClassISAList
  @rdf:type: DISPerl|BlockCode
  @enDesc:
    Makes the list of <QUOTE::is-a> classes of a class.
  @PerlDef:
    unless ($Message::DOM::ClassISA{$CLASS}) {
      no strict 'refs';
      my %__class;
      my @__chk = ($CLASS);
      while (my $__chk = shift @__chk) {
        $__class{$__chk} = true;
        for my $__isa (@{$__chk . '::ISA'}) {
          if ($__isa !~ /::IF(?:Level.|Latest)?::/ and 
              not $__class{$__isa}) {
            push @__chk, $__isa;
          }
        }
      }
      $Message::DOM::ClassISA{$CLASS} = [keys %__class];
    }
  @For: ManakaiDOM|ManakaiDOM3

## -- Simplified DOMImplementation interface

minIFClsDef:
  @IFQName: MinimumImplementation
  @ClsQName: ManakaiMinimumImplementation

  @Description:
    @@lang:en
    @@@:
      The <IF::MinimumImplementation> interface 
      is a subset of the DOM Level 3 <IF::DOMCore:DOMImplementation>
      interface.  This interface provides only two methods:
      <M::GetFeature.hasFeature> (DOM Level 1) and
      <M::GetFeature.getFeature> (DOM Level 3).

  @ISA:
    @@@:
      ManakaiNode:ManakaiNodeRef::ManakaiDOM:Perl
    @@ForCheck:
      ManakaiDOM:ManakaiDOM ManakaiDOM:ForClass

  @Implement: GetFeature
  @ISA:
    @@@@: GetFeature
    @@@ForCheck: ManakaiDOM|ForIF

  @DISLang:role: DOMMetaImpl|ManakaiDOMImplementationRole

  @f:provides: min30
  
  @Method:
    @@Name:  hasFeature
    @@ForCheck: ManakaiDOM|ForClass
    @@Description:
      @@@lang:en
      @@@@:
         Tests whether this implementation supports a specific 
         feature and version or not.
    @@Param:
      @@@Name:  feature
      @@@Type: MIString
      @@@actualType: FeatureNameString
      @@@Description:
        @@@@lang:en
        @@@@@: 
          The name of the feature to test, with or without 
          <CHAR::PLUS SIGN> prefix.
    @@Param:
      @@@Name:  version
      @@@Type: MIString
      @@@actualType: FeatureVersionString
      @@@Description:
        @@@@lang:en
        @@@@@:
          The version number of the feature to test. 
    @@Return:
      @@@Type:  
        DOMMain:boolean::ManakaiDOM:all
      @@@Description:
        @@@@lang:en
        @@@@@: 
          Whether the feature and version is implemented or not.
      @@@InCase:
        @@@@Value: 
          @@@@@@:1
          @@@@@ContentType: DISCore|Boolean
        @@@@Description:
          @@@@@lang:en
          @@@@@@: 
            The <P::feature> is implemented in the specified <P::version>.
      @@@InCase:
        @@@@Value: 
          @@@@@@:0
          @@@@@ContentType: DISCore|Boolean
        @@@@Description:
          @@@@@lang:en
          @@@@@@: The feature is not implemented.
        @@@PerlCDef:
            my $plus = $feature =~ s/^\+// ? 1 : 0;
            my $class = ref $self;
            __CODE{makeClassISAList:: $CLASS => $class}__;
            if (defined $Message::DOM::ImplFeature{$class}
                                ->{$feature}->{$version}) {
              $r = $Message::DOM::ImplFeature{$class}
                                ->{$feature}->{$version};
            } elsif ($plus) {
              CLASS: for my $class (grep {
                $Message::DOM::ManakaiDOMImplementation::CompatClass{$_}
              } keys %Message::DOM::ManakaiDOMImplementation::CompatClass) {
                for my $cls ($class, @{$Message::DOM::ClassISA{$class}}) {
                  if ($Message::DOM::ImplFeature{$class}
                                   ->{$feature}->{$version}) {
                    $r = true;
                    last CLASS;
                  }
                }
              }
            }

  @Method:
     @@Name:  getFeature
     @@ForCheck: ManakaiDOM|ForClass
     @@Description:
        @@@lang:en
        @@@@:
          Returns a specialized object that implements the specialized 
          interfaces of the specified feature and version.
     @@Param:
        @@@Name:  feature
        @@@Type: MIString
        @@@actualType: FeatureNameString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A feature name to request.
     @@Param:
        @@@Name:  version
        @@@Type: MIString
        @@@actualType: FeatureVersionString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A feature version number to request.
     @@Return:
        @@@Type: DOMMain|Object||ManakaiDOM|all
        @@@Description:
          @@@@lang:en
          @@@@@:
            An object that implements the specialized APIs of the 
            <P::feature> and <P::version>.  It might or might not 
            implements the <IF::MinimumImplementation> interface. 
            In addition, the object might or might not part of 
            manakai. 

            If the object implements the <IF::MinimumImplementation>
            interface or the <IF::DOMCore:DOMImplementation>, 
            it must delegate to the primary core <IF::MinimumImplementation> 
            and must not result incosistent with the primary core 
            <IF::MinimumImplementation> such as
            <M::GetFeature.hasFeature>, 
            <M::GetFeature.getFeature>, etc.
        @@@InCase:
          @@@@Value:
            @@@@@is-null:1
          @@@@enDesc:
            There is no object available that implements interfaces 
            associated with the <P::feature> and <P::version>. 
        @@@PerlCDef:
            $feature =~ s/^\+//;
            CLASS: for my $class (grep {
              $Message::DOM::ManakaiDOMImplementation::CompatClass{$_}
            } keys %Message::DOM::ManakaiDOMImplementation::CompatClass) {
              __CODE{makeClassISAList:: $CLASS => $class}__;
              for my $cls ($class, @{$Message::DOM::ClassISA{$class}}) {
                if ($Message::DOM::ImplFeature{$class}->{$feature}->{$version}) {
                  __CODE{ManakaiNode|getNewReference||ManakaiDOM|Perl::
                    $object => {$self->{<H::mn:node>}},
                    $ref => $r,
                    $class => $class,
                  }__;
                  last CLASS;
                }
              }
            }

  @Method:
    @@Name:new
    @@ManakaiDOM:isForInternal:1
    @@ForCheck: ManakaiDOM|ForClass
    @@enDesc:
      Constructs a new instance of <IF::ManakaiMinimumImplementation>
      and returns it.

    @@Return:
      @@@Type: ManakaiMinimumImplementation
      @@@Description:
        @@@@lang:en
        @@@@@:
          The newly created implementation object.
      @@@PerlDef:
          my $node = <ClassM::ManakaiNode:ManakaiNodeStem::ManakaiDOM:Perl.new>
                         ($self);
          __CODE{ManakaiNode|getNewReference||ManakaiDOM|Perl::
            $object => $node,
            $ref => $r,
            $class => $self,
          }__;
          $node->{<H::ManakaiDOM:implID>} = $node->{<H::mn:nodeID>};

  @Method:
    @@Operator:
      @@@@: eq
      @@@ContentType: DISPerl|Perl
    @@ForCheck: ManakaiDOM|Perl
    @@ManakaiDOM:isForInternal:1
    @@enDesc:
      For Perl binding, the <Perl::eq> operation to a <IF::MinimumImplementation>
      object <kwd:MUST> return <DOM::true> value if and only if
      another operand is a <IF::MinimumImplementation> representing
      the same implementation object and any methods defined in the
      <IF::MinimumImplementation> interface would return the same result.
      
        {NOTE:: The <Perl::eq> operation for two different object
                with different interfaces representing the same implementation
                would return <DOM::true>.
        }
    @@ImplNote:
      @@@lang:en
      @@@@:
        {ISSUE:: Is this definition harmless?
        }
    @@Param:
      @@@Name: obj
      @@@Type: DISPerl|Any
      @@@enDesc:
        Another operand.
      @@@InCase:
        @@@@Value:
          @@@@@is-null:1
        @@@@enDesc:
          Another operand is <DOM::null> and the method would
          return <DOM::false>.
    @@Return:
      @@@Type: idl|boolean||ManakaiDOM|all
      @@@enDesc:
        Whether the implementation and <P::obj> is the same or not.
      @@@PerlDef:
        if (UNIVERSAL::isa ($obj,
                            <ClassName::mn:ManakaiNodeRef::ManakaiDOM:Perl>)) {
          $r = ($obj->{<H::mn:node>}->{<H::mn:nodeID>}
                  eq $self->{<H::mn:node>}->{<H::mn:nodeID>});
        }
    @@Test:
      @@@ForCheck: ManakaiDOM|ForClass
      @@@enDesc:
        The same object would return <DOM::true>.
      @@@PerlDef:
        my $ia = <Class::ManakaiMinimumImplementation>->_new;
        $test->assert_equals ($ia, $ia);
    @@Test:
      @@@ForCheck: ManakaiDOM|ForClass
      @@@enDesc:
        Two different implementations would return <DOM::false>.
      @@@PerlDef:
        my $ia = <Class::ManakaiMinimumImplementation>->_new;
        my $ib = <Class::ManakaiMinimumImplementation>->_new;
        $test->assert_not_equals ($ia, $ib);
##MinimumImplementation

PropDef:
  @QName: ManakaiDOM|implID
  @enDesc:
    The identifier of an implementation.
  @Type: DISPerl|String
  @ManakaiNode:stemName: implid
  @rdfs:domain: f|MinimumImplementation||ManakaiDOM|ManakaiDOM

ResourceDef:
  @QName: DOMMetaImpl|ManakaiDOMMinimumImplementation
  @For: ManakaiDOM|ManakaiDOM3
  @AliasFor: ManakaiMinimumImplementation
  @ImplNote:
    @@lang:en
    @@@:
      This historical alias will be removed.

ResourceDef:
  @QName: DOMMetaImpl|ManakaiDOMMinimumImplementationIF
  @For: ManakaiDOM|ManakaiDOM3
  @AliasFor: MinimumImplementation

ResourceDef:
  @For: ManakaiDOM|DOM3
  @For: =ManakaiDOM|ManakaiDOM
  @rdf:type:
    @@@: dis|MultipleResource
    @@ForCheck: !ManakaiDOM|ForClass !ManakaiDOM|ForIF
  @resourceFor: ManakaiDOM|ForIF
  @resourceFor:
    @@@: ManakaiDOM|ForClass
    @@For: ManakaiDOM|ManakaiDOM3

  @rdf:type:
    @@@: DISLang|Interface
    @@ForCheck: ManakaiDOM|ForIF
    @@For: ManakaiDOM|ManakaiDOM
  @rdf:type:
    @@@: idl|Interface
    @@ForCheck: ManakaiDOM|ForIF
    @@For: ManakaiDOM|ForSpec
  @IFQName: GetFeature

  @rdf:type:
    @@@: DISLang|Class
    @@ForCheck: ManakaiDOM|ForClass
  @ClsQName: ManakaiHasFeatureByGetFeature

  @enDesc:
    The <IF::GetFeature> interface provides the <M::.hasFeature>
    and <M::.getFeature> methods to test or to retrieve an object with
    specified feature.

  @enDesc:
    @@ForCheck: ManakaiDOM|ForClass
    @@@:
      The class <Class::ManakaiHasFeatureByGetFeature> provides
      a method, <M::.hasFeature>, which is implemented by
      calling the <M::.getFeature> method and testing if 
      the method returns non-<DOM::null> value or not.
      A class that only implements the <M::GetFeature.getFeature>
      method can claim that it is implementing the <IF::GetFeature>
      interface by inheriting the <Class::ManakaiHasFeatureByGetFeauture>
      class.

  @Method:
    @@Name:  hasFeature
    @@Description:
      @@@lang:en
      @@@@:
         Tests whether this object supports a specific 
         feature and version or not.
    @@Param:
      @@@Name:  feature
      @@@Type: MIString
      @@@actualType: FeatureNameString
      @@@Description:
        @@@@lang:en
        @@@@@: 
          The name of the feature to test, with or without 
          <CHAR::PLUS SIGN> prefix.
    @@Param:
      @@@Name:  version
      @@@Type: MIString
      @@@actualType: FeatureVersionString
      @@@Description:
        @@@@lang:en
        @@@@@:
          The version number of the feature to test. 
      @@@InCase:
        @@@@Value:
          @@@@@is-null:1
        @@@@enDesc: Any version of the feature.
    @@Return:
      @@@Type:  
        DOMMain:boolean::ManakaiDOM:all
      @@@Description:
        @@@@lang:en
        @@@@@: 
          Whether the feature and version is implemented or not.
      @@@InCase:
        @@@@Value:
          @@@@@@:1
          @@@@@ContentType: DISCore|Boolean
        @@@@Description:
          @@@@@lang:en
          @@@@@@: 
            The <P::feature> is implemented in the specified <P::version>.
      @@@InCase:
        @@@@Value:
          @@@@@@:0
          @@@@@ContentType: DISCore|Boolean
        @@@@Description:
          @@@@@lang:en
          @@@@@@: The feature is not implemented.
        @@@PerlCDef:
          __DEEP{
            $r = defined $self-><M::GetFeature.getFeature> ($feature, $version)
                 ? true : false;
          }__;

  @Method:
    @@ForCheck: ManakaiDOM|ForIF
     @@Name:  getFeature
     @@Description:
        @@@lang:en
        @@@@:
          Returns a specialized object that implements the specialized 
          interfaces of the specified feature and version.
     @@Param:
        @@@Name:  feature
        @@@Type: MIString
        @@@actualType: FeatureNameString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A feature name to request.
     @@Param:
        @@@Name:  version
        @@@Type: MIString
        @@@actualType: FeatureVersionString
        @@@Description:
          @@@@lang:en
          @@@@@:
            A feature version number to request.
      @@@InCase:
        @@@@Value:
          @@@@@is-null:1
        @@@@enDesc: Any version of the feature.
     @@Return:
        @@@Type: DOMMain|Object||ManakaiDOM|all
        @@@Description:
          @@@@lang:en
          @@@@@:
            An object that implements the specialized APIs of the 
            <P::feature> and <P::version>.  It might or might not 
            implements the <IF::GetFeature> interface, although
            such object is encouraged to implement the interface. 

            If the object implements the <IF::GetFeature> interface,
            it must delegate to the primary core <IF::GetFeature> 
            and must not result incosistent with the primary core 
            <IF::GetFeature> such as
            <M::GetFeature.hasFeature>, 
            <M::GetFeature.getFeature>, etc.
        @@@InCase:
          @@@@Value:
            @@@@@is-null:1
          @@@@@: 
            There is no object available that implements interfaces 
            associated with the <P::feature> and <P::version>. 
##GetFeature

PropDef:
  @QName:
    DOMCore:implementation
  @Description:
    @@lang:en
    @@@:
      The implementation object.
  @mn:stemName: impl

ElementTypeBinding:
  @Name: PerlDef
  @ElementType:
    dis:Def
  @ShadowContent:
    @@ContentType:
      lang:Perl

ElementTypeBinding:
  @Name: PerlCDef
  @ElementType:
    dis:Def
  @ShadowContent:
    @@ContentType:
      lang:Perl
    @@ForCheck: ManakaiDOM|ForClass

ElementTypeBinding:
  @Name: PropDef
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type:
      rdf:Property
    @@For: =ManakaiDOM|all

ElementTypeBinding:
  @Name: Attr
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|Attribute
    @@ForCheck:
      ManakaiDOM:DOM !=ManakaiDOM:ManakaiDOM

ElementTypeBinding:
  @Name: Get
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|AttributeGet

ElementTypeBinding:
  @Name: Set
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|AttributeSet

ElementTypeBinding:
  @Name: Method
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|Method
    @@ForCheck:
      ManakaiDOM:DOM !=ManakaiDOM:ManakaiDOM

ElementTypeBinding:
  @Name: Param
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|MethodParameter

ElementTypeBinding:
  @Name: Return
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|MethodReturn

ElementTypeBinding:
  @Name: InCase
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type:
      ManakaiDOM:InCase

ElementTypeBinding:
  @Name: StringDataTypeDef
  @ElementType:
    dis:ResourceDef
  @ShadowContent:
    @@rdf:type: DISLang|DataType
    @@rdfs:subClassOf:
      @@@@: MIString
      @@@For: ManakaiDOM|DOM
    @@For: ManakaiDOM|DOM
    @@For: ManakaiDOM|ForSpec

ElementTypeBinding:
  @Name: IFQName
  @ElementType:
    dis:QName
  @ShadowContent:
    @@ForCheck:
      ManakaiDOM:ForIF

ElementTypeBinding:
  @Name: ClsQName
  @ElementType:
    dis:QName
  @ShadowContent:
    @@ForCheck:
      ManakaiDOM:ForClass
